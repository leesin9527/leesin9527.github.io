<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>MySQL高级 | leesin</title><meta name="author" content="leesin"><meta name="copyright" content="leesin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="1.其他1.1.DDL（数据定义语言）数据库操作 12345678910# 查询所有数据库show databases;# 查询当前使用的数据库select database();# 创建数据库create database [if not exists] 数据库名 [default charset 字符集] [collate 排序规则];# 删除数据库drop database [ if exi">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL高级">
<meta property="og:url" content="https://leesin9527.github.io/post/1.html">
<meta property="og:site_name" content="leesin">
<meta property="og:description" content="1.其他1.1.DDL（数据定义语言）数据库操作 12345678910# 查询所有数据库show databases;# 查询当前使用的数据库select database();# 创建数据库create database [if not exists] 数据库名 [default charset 字符集] [collate 排序规则];# 删除数据库drop database [ if exi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cdn.leesin.fun/hexo/article/1.jpg">
<meta property="article:published_time" content="2022-10-30T01:05:50.000Z">
<meta property="article:modified_time" content="2023-03-27T07:27:47.733Z">
<meta property="article:author" content="leesin">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cdn.leesin.fun/hexo/article/1.jpg"><link rel="shortcut icon" href="https://cdn.leesin.fun/hexo/favicon.png"><link rel="canonical" href="https://leesin9527.github.io/post/1.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-27 15:27:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/myStyle.css"><link rel="stylesheet" href="/css/frontSetting.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/universe.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.leesin.fun/hexo/avatar.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-video"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://cdn.leesin.fun/hexo/article/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="leesin"><span class="site-name">leesin</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-video"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-30T01:05:50.000Z" title="发表于 2022-10-30 09:05:50">2022-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-27T07:27:47.733Z" title="更新于 2023-03-27 15:27:47">2023-03-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">18.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>71分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-其他"><a href="#1-其他" class="headerlink" title="1.其他"></a>1.其他</h1><h2 id="1-1-DDL（数据定义语言）"><a href="#1-1-DDL（数据定义语言）" class="headerlink" title="1.1.DDL（数据定义语言）"></a>1.1.DDL（数据定义语言）</h2><p>数据库操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查询所有数据库</span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"># 查询当前使用的数据库</span><br><span class="line"><span class="keyword">select</span> database();</span><br><span class="line"># 创建数据库</span><br><span class="line"><span class="keyword">create</span> database [if <span class="keyword">not</span> <span class="keyword">exists</span>] 数据库名 [<span class="keyword">default</span> charset 字符集] [<span class="keyword">collate</span> 排序规则];</span><br><span class="line"># 删除数据库</span><br><span class="line"><span class="keyword">drop</span> database [ if exitsts ] 数据库名;</span><br><span class="line"># 使用数据库</span><br><span class="line">use 数据库名;</span><br></pre></td></tr></table></figure>
<p>表操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查询当前数据库所有表</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"># 查询表结构</span><br><span class="line"><span class="keyword">desc</span> 表名;</span><br><span class="line"># 查询指定表的建表语句</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> 表名;</span><br><span class="line"># 添加字段</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> 字段名 类型(长度) [comment 注释] [约束];</span><br><span class="line"># 修改数据类型</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify 字段名 新数据类型(长度);</span><br><span class="line"># 修改字段名和字段类型</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 change 旧字段名 新字段名 类型(长度) [comment 注释] [约束];</span><br></pre></td></tr></table></figure>
<h2 id="1-2-DML（数据操作语言）"><a href="#1-2-DML（数据操作语言）" class="headerlink" title="1.2.DML（数据操作语言）"></a>1.2.DML（数据操作语言）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> ...</span><br><span class="line"><span class="keyword">update</span> ...</span><br><span class="line"><span class="keyword">delete</span> ...</span><br></pre></td></tr></table></figure>
<h2 id="1-3-DQL（数据查询语言）"><a href="#1-3-DQL（数据查询语言）" class="headerlink" title="1.3.DQL（数据查询语言）"></a>1.3.DQL（数据查询语言）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br></pre></td></tr></table></figure>
<p>DQL执行顺序:</p>
<p>FROM -&gt; WHERE -&gt; GROUP BY -&gt; SELECT -&gt; ORDER BY -&gt; LIMIT</p>
<h2 id="1-4-DCL（管理用户）"><a href="#1-4-DCL（管理用户）" class="headerlink" title="1.4.DCL（管理用户）"></a>1.4.DCL（管理用户）</h2><h1 id="2-事务"><a href="#2-事务" class="headerlink" title="2.事务"></a>2.事务</h1><h2 id="2-1-事务简介"><a href="#2-1-事务简介" class="headerlink" title="2.1.事务简介"></a>2.1.事务简介</h2><p>事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作==要么同时成功，要么同时失败。==</p>
<p><strong>默认MySQL的事务是自动提交的，也就是说，当执行一条DML语句，MySQL会立即隐式的提交事务。</strong></p>
<h2 id="2-2-事务操作"><a href="#2-2-事务操作" class="headerlink" title="2.2.事务操作"></a>2.2.事务操作</h2><p>方式1，将事务设置为手动提交</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看事务的提交方式，<span class="number">1</span>表示自动提交，<span class="number">0</span>表示手动提交</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@autocommit</span>;</span><br><span class="line"></span><br><span class="line"># 设置事务提交方式为手动提交</span><br><span class="line"><span class="keyword">set</span> @<span class="variable">@autocommit</span><span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"># 提交事务</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"># 回滚事务</span><br><span class="line"><span class="keyword">rollback</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>方式2，不修改事务的提交方式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 开启事务，以下两条语句都是可以的。</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 提交事务</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"># 回滚事务</span><br><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-事务四大特性ACID⭐⭐⭐"><a href="#2-3-事务四大特性ACID⭐⭐⭐" class="headerlink" title="2.3.事务四大特性ACID⭐⭐⭐"></a>2.3.事务四大特性ACID⭐⭐⭐</h2><p>原子性 (Atomicity)：事务是不可分割的最小操作单元，要么全部成功，要么全部失败</p>
<p>一致性(Consistency)：事务完成时，必须使所有的数据都保持一致状态。</p>
<p>隔离性 (lsolation)：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</p>
<p>持久性 (Durability)：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。</p>
<h2 id="2-4-并发事务问题⭐⭐⭐"><a href="#2-4-并发事务问题⭐⭐⭐" class="headerlink" title="2.4.并发事务问题⭐⭐⭐"></a>2.4.并发事务问题⭐⭐⭐</h2><p>脏读：一个事务读取到另一个事务还没有提交的数据。</p>
<p>不可重复读：一个事务先后读取同一条记录，但两次读取的数据不同。</p>
<p>幻读：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在了，好像出现了”幻影“。</p>
<h2 id="2-5-事务的隔离级别⭐⭐⭐"><a href="#2-5-事务的隔离级别⭐⭐⭐" class="headerlink" title="2.5.事务的隔离级别⭐⭐⭐"></a>2.5.事务的隔离级别⭐⭐⭐</h2><p>不同隔离级别能解决的问题： </p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">隔离级别</th>
<th style="text-align:center">脏读</th>
<th style="text-align:center">不可重复读</th>
<th style="text-align:center">幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Read uncommitted</td>
<td style="text-align:center">×</td>
<td style="text-align:center">×</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td style="text-align:center">Read committed</td>
<td style="text-align:center">√</td>
<td style="text-align:center">×</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td style="text-align:center">Repeatable Read(默认)</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td style="text-align:center">Serializable</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 查看事务的隔离级别</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"></span><br><span class="line"># 设置事务的隔离级别</span><br><span class="line"><span class="keyword">set</span> [session <span class="operator">|</span> <span class="keyword">global</span>] transaction isolation level &#123;read uncommitted <span class="operator">|</span> read committed <span class="operator">|</span> repeatable read <span class="operator">|</span> serializable&#125;;</span><br><span class="line"></span><br><span class="line"># 设置本会话的事务级别为 读未提交</span><br><span class="line"><span class="keyword">set</span> session transaction isolation level read uncommitted;</span><br><span class="line"># 设置本会话的事务级别为 读已提交</span><br><span class="line"><span class="keyword">set</span> session transaction isolation level read committed;</span><br><span class="line"># 设置本会话的事务级别为 可重复读</span><br><span class="line"><span class="keyword">set</span> session transaction isolation level repeatable read;</span><br><span class="line"># 设置本会话的事务级别为 串行化</span><br><span class="line"><span class="keyword">set</span> session transaction isolation level serializable;</span><br><span class="line"></span><br><span class="line"># 经我初步测试：设置<span class="keyword">global</span>的事务级别，需要重启会话才能生效。</span><br><span class="line"># 设置全局的事务级别为 读未提交</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level read uncommitted;</span><br><span class="line"># 设置全局的事务级别为 读已提交</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level read committed;</span><br><span class="line"># 设置全局的事务级别为 可重复读</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level repeatable read;</span><br><span class="line"># 设置全局的事务级别为 串行化</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level serializable;</span><br></pre></td></tr></table></figure>
<h1 id="3-MySQL体系结构"><a href="#3-MySQL体系结构" class="headerlink" title="3.MySQL体系结构"></a>3.MySQL体系结构</h1><p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308221800263.png" alt="image-20230308221800263"></p>
<ul>
<li>连接层：最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</li>
<li>服务层：第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如 过程、函数等。</li>
<li>引擎层：存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎。</li>
<li>存储层：主要是将数据存储在文件系统之上，并完成与存储引擎的交互。</li>
</ul>
<h1 id="4-存储引擎"><a href="#4-存储引擎" class="headerlink" title="4.存储引擎"></a>4.存储引擎</h1><h2 id="4-1-InnoDB-逻辑存储结构"><a href="#4-1-InnoDB-逻辑存储结构" class="headerlink" title="4.1.InnoDB 逻辑存储结构"></a>4.1.InnoDB 逻辑存储结构</h2><p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308215852555.png" alt="image-20230308215852555"></p>
<h2 id="4-2-InnoDB和MyISAM和Memory对比"><a href="#4-2-InnoDB和MyISAM和Memory对比" class="headerlink" title="4.2.InnoDB和MyISAM和Memory对比"></a>4.2.InnoDB和MyISAM和Memory对比</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">特点</th>
<th style="text-align:center">InnoDB</th>
<th style="text-align:center">MyISAM</th>
<th style="text-align:center">Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">存储限制</td>
<td style="text-align:center">64TB</td>
<td style="text-align:center">有</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:center">事务安全</td>
<td style="text-align:center">==支持==</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">锁机制</td>
<td style="text-align:center">==行锁==</td>
<td style="text-align:center">表锁</td>
<td style="text-align:center">表锁</td>
</tr>
<tr>
<td style="text-align:center">B+tree索引</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center">Hash索引</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center"><strong>支持</strong></td>
</tr>
<tr>
<td style="text-align:center">全文索引</td>
<td style="text-align:center">支持（5.6版本之后）</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">空间使用</td>
<td style="text-align:center">高</td>
<td style="text-align:center">低</td>
<td style="text-align:center">N/A</td>
</tr>
<tr>
<td style="text-align:center">内存使用</td>
<td style="text-align:center">高</td>
<td style="text-align:center">低</td>
<td style="text-align:center">中等</td>
</tr>
<tr>
<td style="text-align:center">批量插入速度</td>
<td style="text-align:center">低</td>
<td style="text-align:center">高</td>
<td style="text-align:center">高</td>
</tr>
<tr>
<td style="text-align:center">支持外键</td>
<td style="text-align:center">==支持==</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p><strong>总结：InnoDB支持事务，行级锁，外键。</strong></p>
</blockquote>
<h2 id="4-3-存储引擎的选择"><a href="#4-3-存储引擎的选择" class="headerlink" title="4.3.存储引擎的选择"></a>4.3.存储引擎的选择</h2><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p>
<ul>
<li>InnoDB: 如果应用对事物的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，则 InnoDB 是比较合适的选择</li>
<li>MyISAM: 如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不高，那这个存储引擎是非常合适的。<strong>（被MongoDB替代了）</strong></li>
<li>Memory: 将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。Memory 的缺陷是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性<strong>（被Redis替代了）</strong></li>
</ul>
<p>电商中的足迹和评论适合使用 MyISAM 引擎，缓存适合使用 Memory 引擎。</p>
<h1 id="5-索引"><a href="#5-索引" class="headerlink" title="5.索引"></a>5.索引</h1><h2 id="5-1-优缺点"><a href="#5-1-优缺点" class="headerlink" title="5.1.优缺点"></a>5.1.优缺点</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">优点</th>
<th style="text-align:left">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">提高数据检索效率，降低数据库的IO成本</td>
<td style="text-align:left">索引列也是要占用空间的</td>
</tr>
<tr>
<td style="text-align:left">通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</td>
<td style="text-align:left">索引大大提高了查询效率，但降低了更新的速度，比如 INSERT、UPDATE、DELETE</td>
</tr>
</tbody>
</table>
</div>
<h2 id="5-2-索引结构"><a href="#5-2-索引结构" class="headerlink" title="5.2.索引结构"></a>5.2.索引结构</h2><div class="table-container">
<table>
<thead>
<tr>
<th>索引结构</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>B+Tree</td>
<td>最常见的索引类型，大部分引擎都支持B+树索引</td>
</tr>
<tr>
<td>Hash</td>
<td>底层数据结构是用哈希表实现，只有精确匹配索引列的查询才有效，<strong>不支持范围查询</strong></td>
</tr>
<tr>
<td>R-Tree(空间索引)</td>
<td>空间索引是 MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</td>
</tr>
<tr>
<td>Full-Text(全文索引)</td>
<td>是一种通过建立倒排索引，快速匹配文档的方式，类似于 Lucene, Solr, ES</td>
</tr>
</tbody>
</table>
</div>
<p>支持情况：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>索引</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>B+Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Hash索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>R-Tree索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Full-text</td>
<td>5.6版本后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>注：我们平常所说的索引，如果没有特别指明，都是指B+树结构组织的索引。</p>
</blockquote>
<h3 id="5-2-1-二叉搜索树"><a href="#5-2-1-二叉搜索树" class="headerlink" title="5.2.1.二叉搜索树"></a>5.2.1.二叉搜索树</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/二叉搜索树.png" alt="二叉搜索树"></p>
<p><strong>二叉树缺点: 顺序插入时，会形成一个链表，查询性能大大降低。时间复杂度为O(N)</strong></p>
<blockquote>
<p>为什么不用红黑树？</p>
<p>红黑树也是二叉树，大数据量情况下，层级较深，检索速度慢。</p>
</blockquote>
<h3 id="5-2-2-B-Tree（多路平衡查找树）"><a href="#5-2-2-B-Tree（多路平衡查找树）" class="headerlink" title="5.2.2.B-Tree（多路平衡查找树）"></a>5.2.2.B-Tree（多路平衡查找树）</h3><p>为了解决层级较深问题，采用B-Tree。</p>
<p>以5阶B-Tree为例（每个节点最多存储4个key，5个指针）</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308223104616.png" alt="image-20230308223104616"></p>
<h3 id="5-2-3-B-Tree"><a href="#5-2-3-B-Tree" class="headerlink" title="5.2.3.B+Tree"></a>5.2.3.B+Tree</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308223830882.png" alt="image-20230308223830882"></p>
<blockquote>
<p>与 B-Tree 的区别：</p>
<ul>
<li>所有的数据都会出现在叶子节点</li>
<li>叶子节点形成一个单向链表</li>
</ul>
</blockquote>
<h3 id="5-2-4-MySQL的B-Tree"><a href="#5-2-4-MySQL的B-Tree" class="headerlink" title="5.2.4.MySQL的B+Tree"></a>5.2.4.MySQL的B+Tree</h3><p>MySQL 索引数据结构对经典的 B+Tree 进行了优化。在原 B+Tree 的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的 B+Tree，提高区间访问的性能。</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308224034350.png" alt="image-20230308224034350"></p>
<h3 id="5-2-5-Hash"><a href="#5-2-5-Hash" class="headerlink" title="5.2.5.Hash"></a>5.2.5.Hash</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230308224658146.png" alt="image-20230308224658146"></p>
<blockquote>
<p>Hash索引特点：</p>
<ul>
<li>Hash索引只能用于对等比较（=、in），不支持范围查询（betwwn、&gt;、&lt;、…）</li>
<li>无法利用索引完成排序操作</li>
<li>查询效率高，通常只需要一次检索就可以了，效率通常要高于 B+Tree 索引</li>
</ul>
<p>解决哈希冲突的方式为：拉链法。</p>
<p>在MySQL中，支持hash索引的是Memory引擎，而lnnoDB中具有自适应hash功能，hash索引是存储引擎根据B+Tree索引在指定条件下自动构<br>建的。</p>
</blockquote>
<h3 id="5-2-6-面试题⭐⭐⭐"><a href="#5-2-6-面试题⭐⭐⭐" class="headerlink" title="5.2.6.面试题⭐⭐⭐"></a>5.2.6.面试题⭐⭐⭐</h3><ol>
<li>为什么 InnoDB 存储引擎选择使用 B+Tree 索引结构？</li>
</ol>
<ul>
<li>相对于二叉树，层级更少，搜索效率高</li>
<li>对于 B-Tree，无论是叶子节点还是非叶子节点，都会保存数据，这样导致一页中存储的键值减少，指针也跟着减少，要同样保存大量数据，只能增加树的高度，导致性能降低</li>
<li>相对于 Hash 索引，B+Tree 支持范围匹配及排序操作</li>
</ul>
<h2 id="5-3-索引分类"><a href="#5-3-索引分类" class="headerlink" title="5.3.索引分类"></a>5.3.索引分类</h2><div class="table-container">
<table>
<thead>
<tr>
<th>分类</th>
<th style="text-align:left">含义</th>
<th>特点</th>
<th>关键字</th>
</tr>
</thead>
<tbody>
<tr>
<td>主键索引</td>
<td style="text-align:left">针对于表中主键创建的索引</td>
<td>默认自动创建，只能有一个</td>
<td>PRIMARY</td>
</tr>
<tr>
<td>唯一索引</td>
<td style="text-align:left">避免同一个表中某数据列中的值重复</td>
<td>可以有多个</td>
<td>UNIQUE</td>
</tr>
<tr>
<td>常规索引</td>
<td style="text-align:left">快速定位特定数据</td>
<td>可以有多个</td>
<td></td>
</tr>
<tr>
<td>全文索引</td>
<td style="text-align:left">全文索引查找的是文本中的关键词，而不是比较索引中的值</td>
<td>可以有多个</td>
<td>FULLTEXT</td>
</tr>
</tbody>
</table>
</div>
<p>在 InnoDB 存储引擎中，根据索引的存储形式，又可以分为以下两种：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>分类</th>
<th>含义</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>聚集索引(Clustered Index)</td>
<td>将数据存储与索引放一块，索引结构的叶子节点保存了行数据</td>
<td>有且只有一个</td>
</tr>
<tr>
<td>二级索引(Secondary Index)</td>
<td>将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键</td>
<td>可以存在多个</td>
</tr>
</tbody>
</table>
</div>
<p>聚集索引选取规则：</p>
<ul>
<li>如果存在主键，主键索引就是聚集索引</li>
<li>如果不存在主键，将使用第一个唯一(UNIQUE)索引作为聚集索引</li>
<li>如果表没有主键或没有合适的唯一索引，则 InnoDB 会自动生成一个 rowid 作为隐藏的聚集索引</li>
</ul>
<p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230310105816240.png" alt="image-20230310105816240"></p>
<h5 id="回表⭐⭐⭐"><a href="#回表⭐⭐⭐" class="headerlink" title="回表⭐⭐⭐"></a>回表⭐⭐⭐</h5><p><img src="http://cdn.leesin.fun/typora/s3/img/image-20230310105825769.png" alt="image-20230310105825769"></p>
<h2 id="5-4-思考题"><a href="#5-4-思考题" class="headerlink" title="5.4.思考题"></a>5.4.思考题</h2><p>1. 以下 SQL 语句，哪个执行效率高？为什么？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;Arm&#x27;</span>;</span><br><span class="line"><span class="comment">-- 备注：id为主键，name字段创建的有索引</span></span><br></pre></td></tr></table></figure>
<p>答：第一条语句，因为第二条需要回表查询，相当于两个步骤。</p>
<p>2. InnoDB 主键索引的 B+Tree 高度为多少？</p>
<p>答：假设一行数据大小为1k，一页中可以存储16行这样的数据。InnoDB 的指针占用6个字节的空间，主键假设为bigint，占用字节数为8.<br>可得公式：<code>n * 8 + (n + 1) * 6 = 16 * 1024</code>，其中 8 表示 bigint 占用的字节数，n 表示当前节点存储的key的数量，(n + 1) 表示指针数量（比key多一个）。算出n约为1170。</p>
<p>如果树的高度为2，那么他能存储的数据量大概为：<code>1171 * 16 = 18736</code>；<br>如果树的高度为3，那么他能存储的数据量大概为：<code>1171 * 1171 * 16 = 21939856</code>。</p>
<p>另外，如果有成千上万的数据，那么就要考虑分表，涉及运维篇知识。</p>
<h2 id="5-5-索引语法"><a href="#5-5-索引语法" class="headerlink" title="5.5.索引语法"></a>5.5.索引语法</h2><p>创建索引<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [ <span class="keyword">UNIQUE</span> <span class="operator">|</span> FULLTEXT ] INDEX index_name <span class="keyword">ON</span> table_name (index_col_name, ...);</span><br></pre></td></tr></table></figure></p>
<p>如果不加 CREATE 后面不加索引类型参数，则创建的是常规索引</p>
<p>查看索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>
<p>删除索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX index_name <span class="keyword">ON</span> table_name;</span><br></pre></td></tr></table></figure>
<h2 id="5-6-索引性能分析"><a href="#5-6-索引性能分析" class="headerlink" title="5.6.索引性能分析"></a>5.6.索引性能分析</h2><h3 id="5-6-1-查看执行频次"><a href="#5-6-1-查看执行频次" class="headerlink" title="5.6.1.查看执行频次"></a>5.6.1.查看执行频次</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_______&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://cdn.leesin.fun/typora/s3/img/show global status like &#39;Com_______&#39;;.png" alt="show global status like &#39;Com_______&#39;;"></p>
<h3 id="5-6-2-慢查询日志⭐⭐⭐"><a href="#5-6-2-慢查询日志⭐⭐⭐" class="headerlink" title="5.6.2.慢查询日志⭐⭐⭐"></a>5.6.2.慢查询日志⭐⭐⭐</h3><p>慢查询日志记录了所有执行时间超过指定参数 （long_query_time，单位: 秒，默认10秒）的所有SQL语句的日志。</p>
<p>MySQL的慢查询日志默认没有开启的，查看是否开启的命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name  <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> slow_query_log <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>需要在MySQL的配置文件 （/etc/my.cnf）中配置如下信息:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 开启MySQL慢日志查询开关</span><br><span class="line">slow_query_log<span class="operator">=</span><span class="number">1</span></span><br><span class="line"># 设置慢日志的时间为<span class="number">2</span>秒，<span class="keyword">SQL</span>语句执行时间超过<span class="number">2</span>秒，就会视为慢查询，记录慢查询日志</span><br><span class="line">long_query_time<span class="operator">=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>配置完毕之后，重新启动MySQL服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<p>查看慢日志文件中记录的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入慢查询日志所在的目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看有什么文件，其中慢查询日志文件是xxx-slow.log</span></span><br><span class="line">ll</span><br><span class="line"></span><br><span class="line">[root@itachi102 mysql]<span class="comment"># cat itachi102-slow.log </span></span><br><span class="line">/usr/sbin/mysqld, Version: 8.0.25 (MySQL Community Server - GPL). started with:</span><br><span class="line">Tcp port: 3306  Unix socket: /var/lib/mysql/mysql.sock</span><br><span class="line">Time                 Id Command    Argument</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>默认情况下，慢查询日志不会记录管理语句，也不会记录不使用索引进行查找的查询。需要在MySQL的配置文件 （/etc/my.cnf）中配置如下信息来更改此行为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#记录执行较慢的管理语句</span></span><br><span class="line">log_slow_admin_statements=1</span><br><span class="line"><span class="comment">#记录执行较慢的未使用索引的语句</span></span><br><span class="line">log_queries_not_using_indexes=1</span><br></pre></td></tr></table></figure>
<h3 id="5-6-3-profile操作"><a href="#5-6-3-profile操作" class="headerlink" title="5.6.3.profile操作"></a>5.6.3.profile操作</h3><blockquote>
<p>show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。</p>
</blockquote>
<p>查看当前MySQL是否支持profile操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@have</span>_profiling;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@have</span>_profiling <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> YES              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>默认profiling是关闭的，可以通过set语句在session/global级别开启profiling</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 查看profiling的开关状态，<span class="number">0</span>表示关闭，<span class="number">1</span>表示开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@profiling</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 将profiling开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 查看是否将profiling成功开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@profiling</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行测试的sql语句后，使用profile查看性能</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#查看每一条<span class="keyword">SQL</span>的耗时基本情况</span><br><span class="line"><span class="keyword">show</span> profiles;</span><br><span class="line"></span><br><span class="line">#查看指定query_id的<span class="keyword">SQL</span>语句各个阶段的耗时情况</span><br><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query query_id;</span><br><span class="line"></span><br><span class="line">#查看指定query_id的<span class="keyword">SQL</span>语句CPU的使用情况</span><br><span class="line"><span class="keyword">show</span> profile cpu <span class="keyword">for</span> query query_id;</span><br></pre></td></tr></table></figure>
<h3 id="5-6-4-explain执行计划"><a href="#5-6-4-explain执行计划" class="headerlink" title="5.6.4.explain执行计划"></a>5.6.4.explain执行计划</h3><blockquote>
<p>EXPLAIN 或者 DESC命令获取 MySQL 如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。</p>
</blockquote>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 直接在<span class="keyword">select</span>语句之前加上关键字explain或<span class="keyword">desc</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>EXPLAIN 各字段含义：</p>
<ul>
<li>id：select 查询的序列号，表示查询中执行 select 子句或者操作表的顺序（id相同，执行顺序从上到下；id不同，值越大越先执行）</li>
<li>select_type：表示 SELECT 的类型，常见取值有 SIMPLE（简单表，即不适用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION中的第二个或者后面的查询语句）、SUBQUERY（SELECT/WHERE之后包含了子查询）等</li>
<li>type：表示连接类型，性能由好到差的连接类型为 NULL、system、const、eq_ref、ref、range、index、all</li>
<li>possible_key：可能应用在这张表上的索引，一个或多个</li>
<li>Key：实际使用的索引，如果为 NULL，则没有使用索引</li>
<li>Key_len：表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好</li>
<li>rows：MySQL认为必须要执行的行数，在InnoDB引擎的表中，是一个估计值，可能并不总是准确的</li>
<li>filtered：表示返回结果的行数占需读取行数的百分比，filtered的值越大越好</li>
</ul>
<h2 id="5-7-索引使用规则"><a href="#5-7-索引使用规则" class="headerlink" title="5.7.索引使用规则"></a>5.7.索引使用规则</h2><h3 id="5-7-1-最左前缀法则⭐⭐⭐"><a href="#5-7-1-最左前缀法则⭐⭐⭐" class="headerlink" title="5.7.1.最左前缀法则⭐⭐⭐"></a>5.7.1.最左前缀法则⭐⭐⭐</h3><ul>
<li>如果索引关联了多列（联合索引），要遵守最左前缀法则，最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。</li>
<li>如果跳跃某一列，索引将部分失效（后面的字段索引失效）。</li>
<li>联合索引中，出现范围查询（&lt;, &gt;），范围查询右侧的列索引失效。可以用&gt;=或者&lt;=来规避索引失效问题。</li>
</ul>
<h3 id="5-7-2-索引失效情况⭐⭐⭐"><a href="#5-7-2-索引失效情况⭐⭐⭐" class="headerlink" title="5.7.2.索引失效情况⭐⭐⭐"></a>5.7.2.索引失效情况⭐⭐⭐</h3><ol>
<li>在索引列上<strong>进行运算操作</strong>，索引将失效。如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 其中 phone 字段有索引</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> <span class="built_in">substring</span>(phone, <span class="number">10</span>, <span class="number">2</span>) <span class="operator">=</span> <span class="string">&#x27;15&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>字符串类型字段使用时，不加引号，索引将失效。如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># phone 字段是字符串类型字段，且此处没用使用引号包裹起来，索引将失效，因为会类型转换</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> phone <span class="operator">=</span> <span class="number">17799990015</span>;</span><br></pre></td></tr></table></figure></li>
<li>模糊查询中，如果仅仅是尾部模糊匹配，索引不会是失效；如果是<strong>头部模糊匹配</strong>，索引失效。如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 索引失效举例</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession <span class="keyword">like</span> <span class="string">&#x27;%工程&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 如果是头部没有用模糊匹配，则不会失效</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession <span class="keyword">like</span> <span class="string">&#x27;软件%&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>用 or 分割开的条件，<strong>如果 or 其中一个条件的列没有索引</strong>，那么涉及的索引都不会被用到。</li>
<li><strong>如果 MySQL 评估使用索引比全表更慢</strong>，则不使用索引。</li>
</ol>
<h3 id="5-7-3-SQL-提示"><a href="#5-7-3-SQL-提示" class="headerlink" title="5.7.3.SQL 提示"></a>5.7.3.SQL 提示</h3><p>是优化数据库的一个重要手段，简单来说，就是在SQL语句中加入一些人为的提示来达到优化操作的目的。</p>
<p>例如，使用索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user use index(idx_user_pro) <span class="keyword">where</span> profession<span class="operator">=</span>&quot;软件工程&quot;;</span><br></pre></td></tr></table></figure><br>不使用哪个索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user ignore index(idx_user_pro) <span class="keyword">where</span> profession<span class="operator">=</span>&quot;软件工程&quot;;</span><br></pre></td></tr></table></figure><br>必须使用哪个索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user force index(idx_user_pro) <span class="keyword">where</span> profession<span class="operator">=</span>&quot;软件工程&quot;;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li><p>use 是建议，实际使用哪个索引 MySQL 还会自己权衡运行速度去更改</p>
</li>
<li><p>force就是无论如何都强制使用该索引。</p>
</li>
</ul>
</blockquote>
<h3 id="5-7-4-覆盖索引-amp-回表查询⭐⭐⭐"><a href="#5-7-4-覆盖索引-amp-回表查询⭐⭐⭐" class="headerlink" title="5.7.4.覆盖索引&amp;回表查询⭐⭐⭐"></a>5.7.4.覆盖索引&amp;回表查询⭐⭐⭐</h3><p>尽量使用覆盖索引（查询使用了索引，并且需要返回的列，在该索引中已经全部能找到），减少 select *。</p>
<blockquote>
<p><strong>explain 中 extra 字段含义</strong><br><code>using index condition</code>：查找使用了索引，但是需要回表查询数据<br><code>using where; using index;</code>：查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询</p>
</blockquote>
<p><img src="http://cdn.leesin.fun/typora/s3/img/覆盖索引-16785139464682.png" alt="覆盖索引"></p>
<p>在上图中，id为主键且有聚集索引，name有二级索引。</p>
<p>①号sql语句使用聚集索引，只需要走一次索引，效率高。</p>
<p>②号sql语句虽然使用name字段的二级索引，但是他只需要 id 字段和 name 字段，也只需要走一次二级索引就OK，效率高。</p>
<p>③号sql语句使用name字段的二级索引，且需要的字段除了 id，name 外，还有一个 gender 字段，如果只走一次二级索引无法找到 gender 字段，所以只能根据 查找到的 id 字段，回表查询，再走一次聚集索引，才能找到 gender 字段，效率相对较低。</p>
<p>所以尽量不要用<code>select *</code>，容易出现回表查询，降低效率，除非有联合索引包含了所有字段</p>
<h5 id="面试题⭐⭐⭐"><a href="#面试题⭐⭐⭐" class="headerlink" title="面试题⭐⭐⭐"></a>面试题⭐⭐⭐</h5><ol>
<li>一张表，有四个字段（id, username, password, status），由于数据量大，需要对以下SQL语句进行优化，该如何进行才是最优方案：<br><code>select id, username, password from tb_user where username=&#39;itcast&#39;;</code></li>
</ol>
<blockquote>
<p>解：给username和password字段建立联合索引，则不需要回表查询，直接覆盖索引</p>
</blockquote>
<ol>
<li>为什么尽量不要用select *</li>
</ol>
<blockquote>
<p>答：避免回表操作</p>
</blockquote>
<h3 id="5-7-5-前缀索引"><a href="#5-7-5-前缀索引" class="headerlink" title="5.7.5.前缀索引"></a>5.7.5.前缀索引</h3><p>当字段类型为字符串(varchar，text等)时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只将字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_xxxx <span class="keyword">on</span> table_name(columnn(n));</span><br></pre></td></tr></table></figure>
<p>前缀长度：可以根据索引的选择性来决定，而选择性是指不重复的索引值（基数）和数据表的记录总数的比值，索引选择性越高则查询效率越高，唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的。<br>求选择性公式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> email) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(email, <span class="number">1</span>, <span class="number">5</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user;</span><br></pre></td></tr></table></figure>
<p>show index 里面的sub_part可以看到接取的长度。</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/前缀索引.png" alt="前缀索引"></p>
<h3 id="5-7-6-设计原则"><a href="#5-7-6-设计原则" class="headerlink" title="5.7.6.设计原则"></a>5.7.6.设计原则</h3><ol>
<li>针对于数据量较大，且查询比较频繁的表建立索引</li>
<li>针对于常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引</li>
<li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</li>
<li>如果是字符串类型的字段，字段长度较长，可以针对于字段的特点，建立前缀索引</li>
<li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</li>
<li>要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价就越大，会影响增删改的效率</li>
<li>如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</li>
</ol>
<h1 id="6-SQL优化"><a href="#6-SQL优化" class="headerlink" title="6.SQL优化"></a>6.SQL优化</h1><h2 id="6-1-插入数据"><a href="#6-1-插入数据" class="headerlink" title="6.1.插入数据"></a>6.1.插入数据</h2><p><code>insert</code> 优化</p>
<ul>
<li>批量插入</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">3</span>, <span class="string">&#x27;Jerry&#x27;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>手动提交事务</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">3</span>, <span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">5</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">6</span>, <span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_test <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;Tom&#x27;</span>),(<span class="number">8</span>,<span class="string">&#x27;Cat&#x27;</span>),(<span class="number">9</span>, <span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>主键顺序插入</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">主键乱序插入 : <span class="number">8</span> <span class="number">1</span> <span class="number">9</span> <span class="number">21</span> <span class="number">88</span> <span class="number">2</span> <span class="number">4</span> <span class="number">15</span> <span class="number">89</span> <span class="number">5</span> <span class="number">7</span> <span class="number">3</span></span><br><span class="line">主键顺序插入 : <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">15</span> <span class="number">21</span> <span class="number">88</span> <span class="number">89</span></span><br></pre></td></tr></table></figure>
<ul>
<li>大批量插入数据</li>
</ul>
<p>如果一次性需要插入大批量数据，使用 <code>insert</code> 语句插入性能较低，此时可以使用 MySQL 数据库提供的 <code>load</code> 指令进行插入。操作如下:</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/load指令.png" alt="load指令"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 客户端连接服务端时，加上参数 <span class="comment">--local-infile（这一行在bash/cmd界面输入）</span></span><br><span class="line">mysql <span class="comment">--local-infile -u root -p</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置全局参数local_infile为<span class="number">1</span>，开启从本地加载文件导入数据的开关</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> local_infile <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@local</span>_infile;</span><br><span class="line"># 执行load指令将准备好的数据，加载到表结构中</span><br><span class="line">load data <span class="keyword">local</span> infile <span class="string">&#x27;/root/sql1.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> <span class="string">&#x27;tb_user&#x27;</span> fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-主键优化"><a href="#6-2-主键优化" class="headerlink" title="6.2.主键优化"></a>6.2.主键优化</h2><ul>
<li>数据组织方式</li>
</ul>
<p>在InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表（Index organized table, IOT）</p>
<ul>
<li>页分裂</li>
</ul>
<p>主键乱序插入可能引起页分裂</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?t=220.7&amp;p=90">https://www.bilibili.com/video/BV1Kr4y1i7ru?t=220.7&amp;p=90</a></p>
</blockquote>
<ul>
<li>页合并</li>
</ul>
<p>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记（flaged）为删除并且它的空间变得允许被其他记录声明使用。当页中删除的记录到达 MERGE_THRESHOLD（默认为页的50%），InnoDB会开始寻找最靠近的页（前后）看看是否可以将这两个页合并以优化空间使用。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?t=484.7&amp;p=90">https://www.bilibili.com/video/BV1Kr4y1i7ru?t=484.7&amp;p=90</a></p>
</blockquote>
<ul>
<li><p><strong>主键设计原则</strong></p>
<ul>
<li><p>满足业务需求的情况下，尽量降低主键的长度</p>
</li>
<li><p>插入数据时，尽量选择顺序插入，选择使用 AUTO_INCREMENT 自增主键</p>
</li>
<li><p>尽量不要使用 UUID 做主键或者是其他的自然主键，如身份证号</p>
</li>
<li><p>业务操作时，避免对主键的修改</p>
</li>
</ul>
</li>
</ul>
<h2 id="6-3-order-by-优化"><a href="#6-3-order-by-优化" class="headerlink" title="6.3. order by 优化"></a>6.3. <code>order by</code> 优化</h2><blockquote>
<p><strong>explain 中 extra 字段含义</strong></p>
<p><code>Using filesort</code>：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区 sort buffer 中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序</p>
<p><code>Using index</code>：通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要额外排序，操作效率高</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 删除之前创建的索引，以免干扰测试</span><br><span class="line"></span><br><span class="line">#没有创建索引时，根据age, phone进行排序</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> filesort</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb_user <span class="keyword">order</span> <span class="keyword">by</span> age, phone;</span><br><span class="line"></span><br><span class="line">#创建索引</span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone_aa <span class="keyword">on</span> tb_user(age,phone);</span><br><span class="line"></span><br><span class="line">#创建索引后，根据age,phone进行升序排序</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index	效率高</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb_user <span class="keyword">order</span> <span class="keyword">by</span> age, phone;</span><br><span class="line"></span><br><span class="line">#创建索引后，根据age, phone进行降序排序</span><br><span class="line">#此时 extra 字段显示的是 Backward index scan, <span class="keyword">Using</span> index	效率高</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb_user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>, phone <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">#根据age,phone进行降序一个升序，一个降序</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb_user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">#创建索引，对上一个<span class="keyword">sql</span>进行优化</span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone_ad <span class="keyword">on</span> tb_user(age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>);</span><br><span class="line"></span><br><span class="line">#根据age,phone进行降序一个升序，一个降序</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index 效率高</span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> tb_user <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://cdn.leesin.fun/typora/s3/img/order by优化.png" alt="order by优化"></p>
<p><strong>总结：</strong></p>
<ul>
<li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</li>
<li>尽量使用覆盖索引</li>
<li>多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则（ASC/DESC）</li>
<li>如果不可避免出现filesort，大数据量排序时，可以适当增大排序缓冲区大小 sort_buffer_size（默认256k）</li>
</ul>
<h2 id="6-4-group-by-优化"><a href="#6-4-group-by-优化" class="headerlink" title="6.4. group by 优化"></a>6.4. <code>group by</code> 优化</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 删除之前创建的索引，以免干扰测试</span><br><span class="line"></span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">#由于没有索引，所以此次操作是全表扫描</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> temporary 表示使用了临时表</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"></span><br><span class="line">#创建联合索引</span><br><span class="line"><span class="keyword">Create</span> index idx_user_pro_age_sta <span class="keyword">on</span> tb_user(profession, age, status);</span><br><span class="line"></span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index 效率高</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"></span><br><span class="line">#执行分组操作，根据profession字段分组</span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index 效率高</span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">group</span> <span class="keyword">by</span> profession, age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#此时 extra 字段显示的是 <span class="keyword">Using</span> index 效率高</span><br><span class="line">explain <span class="keyword">select</span> age, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_user <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> age;</span><br></pre></td></tr></table></figure>
<ul>
<li>在分组操作时，可以通过索引来提高效率</li>
<li>分组操作时，索引的使用也是满足最左前缀法则的</li>
</ul>
<h2 id="6-5-limit-优化"><a href="#6-5-limit-优化" class="headerlink" title="6.5. limit 优化"></a>6.5. <code>limit</code> 优化</h2><p>对于limit来说，在大数据量下进行分页操作，越往后效率越低。</p>
<p>个常见又非常头疼的问题就是 <code>limt 2000000,10</code> ，此时需要MySQL排席前2000010 记录，仅仅返回2000000 - 2000010的记录，其他记录丢弃，查询排序的代价非常大。</p>
<p>优化思路: 一般分页查询时，通过创建 覆盖索引 能够比较好地提高性能，可以通过<strong>覆盖索引</strong>加<strong>子查询</strong>形式进行优化。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 优化前，花费<span class="number">19.39</span>秒</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> tb_sku </span><br><span class="line">limit <span class="number">9000000</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"># 优化后，花费<span class="number">11.46</span>秒</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> tb_sku t , (<span class="keyword">select</span> id </span><br><span class="line">                 <span class="keyword">from</span> tb_sku </span><br><span class="line">                 <span class="keyword">order</span> <span class="keyword">by</span> id </span><br><span class="line">                 limit <span class="number">9000000</span>,<span class="number">10</span>) a </span><br><span class="line"><span class="keyword">where</span> t.id <span class="operator">=</span> a.id;</span><br></pre></td></tr></table></figure>
<h2 id="6-6-count-优化"><a href="#6-6-count-优化" class="headerlink" title="6.6. count 优化"></a>6.6. <code>count</code> 优化</h2><ul>
<li>MyISAM引擎把一个表的总行数存在了磁盘上，因此执行count(*)的时候会直接返回这个数，效率很高</li>
<li>InnoDB引擎就麻烦了，它执行count(*)的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数</li>
</ul>
<blockquote>
<p><strong>优化思路: 自己计数。</strong>使用redis来计数</p>
</blockquote>
<p><strong>count的几种用法</strong></p>
<ul>
<li><p><code>count(主键)</code><br>InnoDB引擎会遍历整张表，把每一行的主键id值都取出来，返回给服务层。服务层拿到主键后，不用判空，直接按行进行累加（主键不可能为null）</p>
</li>
<li><p><code>count(字段)</code></p>
<p>没有not null 约束：InnoDB引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为null。不为null，计数累加；为null，不加。<br>有not null约束：InnoDB 引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，不用判空，直接按行进行累加。</p>
</li>
<li><p><code>count(1)</code><br>InnoDB引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字“1“进去，直接按行进行累加。</p>
</li>
<li><p><code>count(*)</code><br>lnnoDB引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加。</p>
</li>
</ul>
<p><strong>总结</strong></p>
<p>按照效率排序的话，<code>count(字段)</code>&lt; <code>count(主键 id)</code>&lt; <code>count(1)</code> ≈<code>count(*)</code>，所以尽量使用 <code>count(*)</code></p>
<h2 id="6-7-update-优化（避免行锁升级为表锁）"><a href="#6-7-update-优化（避免行锁升级为表锁）" class="headerlink" title="6.7. update 优化（避免行锁升级为表锁）"></a>6.7. <code>update</code> 优化（避免行锁升级为表锁）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># id字段有索引，此<span class="keyword">sql</span>语句加行锁</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> <span class="keyword">no</span> <span class="operator">=</span> <span class="string">&#x27;2000100100&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"># name字段没有设置索引，此<span class="keyword">sql</span>语句加表锁</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> <span class="keyword">no</span> <span class="operator">=</span><span class="string">&#x27;2000100105&#x27;</span> <span class="keyword">where</span> name <span class="operator">=</span><span class="string">&#x27;韦一笑&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>lnnoDB的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁</p>
<h1 id="7-锁"><a href="#7-锁" class="headerlink" title="7.锁"></a>7.锁</h1><p>MySQL中的锁，按照锁的粒度分，分为以下三类:<br>1.全局锁：锁定数据库中的所有表<br>2.表级锁：每次操作锁住整张表。<br>3.行级锁：每次操作锁住对应的行数据。</p>
<h2 id="7-1-全局锁"><a href="#7-1-全局锁" class="headerlink" title="7.1.全局锁"></a>7.1.全局锁</h2><p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML的写语句，DDL语句，已经更新操作的事务提交语句都将被阻塞。<br>其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 加全局锁</span><br><span class="line">flush tables <span class="keyword">with</span> read lock;</span><br><span class="line"></span><br><span class="line"># 释放全局锁</span><br><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>
<p>数据库中加全局锁，是一个比较重的操作，存在以下问题:</p>
<ol>
<li><p>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</p>
</li>
<li><p>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志(binlog)，会导致主从延迟。</p>
</li>
</ol>
<p><strong>白雪警告</strong></p>
<p>在innoDB引擎中，我们可以在备份时加上参数 <code>--single-transaction</code> 参数来完成不加锁的一致性数据备份</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump <span class="comment">--single-transaction -uroot -proot itcast &gt; itcast.sql</span></span><br></pre></td></tr></table></figure>
<h2 id="7-2-表级锁"><a href="#7-2-表级锁" class="headerlink" title="7.2.表级锁"></a>7.2.表级锁</h2><h3 id="7-2-1-读写锁"><a href="#7-2-1-读写锁" class="headerlink" title="7.2.1.读写锁"></a>7.2.1.读写锁</h3><ol>
<li><p>表共享读锁 (read lock)：不会阻塞所有客户端的读，但是会阻塞所有的写。</p>
</li>
<li><p>表独占写锁 (write lock)：其他客户端不能读也不能写，</p>
</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>获取锁的客户端</th>
<th>其他客户端</th>
</tr>
</thead>
<tbody>
<tr>
<td>共享读锁</td>
<td>可以读，不可以写</td>
<td>可以读，不可以写</td>
</tr>
<tr>
<td>独占写锁</td>
<td>可以读，可以写</td>
<td>不可以读，不可以写</td>
</tr>
</tbody>
</table>
</div>
<p>语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 给tb_user加共享读锁</span><br><span class="line">lock tables tb_user read;</span><br><span class="line"># 释放锁</span><br><span class="line">unlock tables;</span><br><span class="line"></span><br><span class="line"># 给tb_user加独占写锁</span><br><span class="line">lock tables tb_user write;</span><br><span class="line"># 释放锁</span><br><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>
<p>客户端断开连接，也会自动释放锁。</p>
<h3 id="7-2-2-元数据锁-meta-data-lock，-MDL"><a href="#7-2-2-元数据锁-meta-data-lock，-MDL" class="headerlink" title="7.2.2.元数据锁 (meta data lock， MDL)"></a>7.2.2.元数据锁 (meta data lock， MDL)</h3><p>MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL锁主要作用是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。为了避免DML与DDL冲突，保证读写的正确性。<br>在MySQL5.5中引入了MDL，当对一张表进行增删改查的时候，加MDL读锁(共享)，当对表结构进行变更操作的时候，加MDL写锁(排他)。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>对应SQL</th>
<th>锁类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>lock tables xxx read</td>
<td>SHARED_READ_ONLY</td>
<td></td>
</tr>
<tr>
<td>lock tables xxx write</td>
<td>SHARED_NO_READ_WRITE</td>
<td></td>
</tr>
<tr>
<td>select、select … lock in share mode</td>
<td>SHARED_READ</td>
<td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>insert、update、delete、select … for update</td>
<td>SHARED_WRITE</td>
<td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>alter table …</td>
<td>EXCLUSIVE</td>
<td>与其他的MDL都互斥</td>
</tr>
</tbody>
</table>
</div>
<p>查看元数据锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_type,object_schema,object_name,lock_type,lock_duration <span class="keyword">from</span> performance_schema.metadata_locks;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-3-意向锁"><a href="#7-2-3-意向锁" class="headerlink" title="7.2.3.意向锁"></a>7.2.3.意向锁</h3><p>为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查。</p>
<ol>
<li>意向共享锁 (IS)：由语句 select…lock in share mode添加。与表共享读锁（read）兼容，与表独占写锁（write）互斥。</li>
<li>意向排他锁 (IX)：由insert、update、delete、select…for update 添加。与表共享读锁（read）及表独占写锁（write）都互斥。</li>
<li>意向锁之间不会互斥。</li>
</ol>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_schema,object_name,index_name,lock_type,lock_mode,lock_data <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说人话，如果事务A执行了 <code>select...lock in share mode</code> ，那么就会加意向共享锁 (IS)，此时，另一客户端尝试加表共享读锁是OK的，尝试加表独占写锁是不行的，会被阻塞住。</p>
<p>如果事务B执行了 <code>insert、update、delete、select...for update</code> 这些语句，那么就会加意向排他锁 (IX)，此时，另一客户端尝试加表共享读锁或表独占写锁都是不行的，会被阻塞住。</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=127">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=127</a></p>
</blockquote>
<h2 id="7-3-行级锁"><a href="#7-3-行级锁" class="headerlink" title="7.3.行级锁"></a>7.3.行级锁</h2><p>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在InnoDB存储引擎中。</p>
<p>lnnoDB的数据是基于索引组织的，<strong>行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的锁</strong>。对于行级锁，主要分为以下三类:</p>
<ol>
<li>行锁(Record Lock)：锁定单个行记录的锁，防止其他事务对此行进行update和delete。在RC、RR隔离级别下都支持。</li>
</ol>
<p><img src="http://cdn.leesin.fun/typora/s3/img/行锁.png" alt="行锁"></p>
<ol>
<li>间隙锁(Gap Lock)：锁定索引记录间隙(不含该记录)，确保索引记录间隙不变，防止其他事务在这个间隙进行inset，产生幻读。在RR隔离级别下都支持</li>
</ol>
<p><img src="http://cdn.leesin.fun/typora/s3/img/间隙锁.png" alt="间隙锁"></p>
<ol>
<li>临键锁(Next-Key Lock)：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。在RR隔离级别下支持</li>
</ol>
<p><img src="http://cdn.leesin.fun/typora/s3/img/临键锁.png" alt="临键锁"></p>
<h3 id="7-3-1-行锁"><a href="#7-3-1-行锁" class="headerlink" title="7.3.1.行锁"></a>7.3.1.行锁</h3><p>InnoDB实现了以下两种类型的行锁:</p>
<ol>
<li>共享锁(S)：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。</li>
<li>排他锁(X)：允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他锁。</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">SQL</th>
<th>行锁类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">insert …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td style="text-align:left">update …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td style="text-align:left">delete …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td style="text-align:left">select</td>
<td>不加任何锁</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">select … lock in share mode</td>
<td>共享锁</td>
<td>需要手动在select之后加lock in share mode</td>
</tr>
<tr>
<td style="text-align:left">select … for update</td>
<td>排他锁</td>
<td>需要手动在select之后加for update</td>
</tr>
</tbody>
</table>
</div>
<p>默认情况下，InnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 临键锁进行搜索和索引扫描，以防止幻读。</p>
<ol>
<li><p>针对唯一索引进行检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。</p>
</li>
<li><p>InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么lnnoDB将对表中的所有记录加锁，此时 就会<strong>升级为表锁。</strong></p>
</li>
</ol>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_schema,object_name,index_name,lock_type,lock_mode,lock_data <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<h3 id="7-3-2-间隙锁-临键锁（学的不是很懂⭐⭐⭐）"><a href="#7-3-2-间隙锁-临键锁（学的不是很懂⭐⭐⭐）" class="headerlink" title="7.3.2.间隙锁/临键锁（学的不是很懂⭐⭐⭐）"></a>7.3.2.间隙锁/临键锁（学的不是很懂⭐⭐⭐）</h3><p>默认情况下，lnnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 临键 锁进行搜索和索引扫描，以防止幻读。</p>
<ol>
<li>索引上的等值查询(唯一索引)，给不存在的记录加锁时，优化为间隙锁 。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">例如：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> account;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三 <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 李四 <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 王五 <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> 李六 <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-------+</span></span><br><span class="line"></span><br><span class="line"># 在这样的表结构下，开启一个事务，执行以下语句</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> money<span class="operator">=</span><span class="number">100</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">7</span>;</span><br><span class="line"># 因为id<span class="operator">=</span><span class="number">7</span>是不存在的记录，所以会优化成id<span class="operator">=</span><span class="number">5</span>到id<span class="operator">=</span><span class="number">9</span>的间隙锁。</span><br><span class="line"></span><br><span class="line"># 然后在另一个客户端开启一个事务，执行测试</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account <span class="keyword">value</span>(<span class="number">6</span>,<span class="string">&#x27;lily&#x27;</span>,<span class="number">2000</span>);</span><br><span class="line"># 会被阻塞住，因为被上了间隙锁</span><br></pre></td></tr></table></figure>
<ol>
<li>索引上的等值查询(普通索引)，向右遍历时最后一个值不满足查询需求时，临键锁退化为间隙锁</li>
<li>索引上的范围查询(唯一索引)—会访问到不满足条件的第一个值为止。</li>
</ol>
<p>注意:间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁。</p>
<h1 id="8-InnoDB引擎"><a href="#8-InnoDB引擎" class="headerlink" title="8.InnoDB引擎"></a>8.InnoDB引擎</h1><h2 id="8-1-InnoDB逻辑存储结构"><a href="#8-1-InnoDB逻辑存储结构" class="headerlink" title="8.1.InnoDB逻辑存储结构"></a>8.1.InnoDB逻辑存储结构</h2><p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB逻辑存储结构.png" alt="InnoDB逻辑存储结构"></p>
<h2 id="8-2-架构"><a href="#8-2-架构" class="headerlink" title="8.2.架构"></a>8.2.架构</h2><p>左侧是内存结构，右侧是磁盘结构</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构.png" alt="InnoDB架构"></p>
<h3 id="8-2-1-内存架构"><a href="#8-2-1-内存架构" class="headerlink" title="8.2.1.内存架构"></a>8.2.1.内存架构</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-内存架构.png" alt="InnoDB架构-内存架构"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-内存架构2.png" alt="InnoDB架构-内存架构2"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-内存架构3.png" alt="InnoDB架构-内存架构3"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-内存架构4.png" alt="InnoDB架构-内存架构4"></p>
<h3 id="8-2-2-磁盘结构"><a href="#8-2-2-磁盘结构" class="headerlink" title="8.2.2.磁盘结构"></a>8.2.2.磁盘结构</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-磁盘架构1.png" alt="InnoDB架构-磁盘架构1"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-磁盘架构2.png" alt="InnoDB架构-磁盘架构2"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-磁盘架构3.png" alt="InnoDB架构-磁盘架构3"></p>
<h3 id="8-2-3-后台线程"><a href="#8-2-3-后台线程" class="headerlink" title="8.2.3.后台线程"></a>8.2.3.后台线程</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/InnoDB架构-后台线程.png" alt="InnoDB架构-后台线程"></p>
<h2 id="8-3-事务原理⭐⭐⭐"><a href="#8-3-事务原理⭐⭐⭐" class="headerlink" title="8.3.事务原理⭐⭐⭐"></a>8.3.事务原理⭐⭐⭐</h2><p><img src="http://cdn.leesin.fun/typora/s3/img/事务原理.png" alt="事务原理"></p>
<h3 id="8-3-1-redo-log"><a href="#8-3-1-redo-log" class="headerlink" title="8.3.1.redo log"></a>8.3.1.redo log</h3><p>==解决事务的持久性==</p>
<p>重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的<strong>持久性</strong>。<br>该日志文件由两部分组成：重做日志缓冲(redo log buffer)以及重做日志文件(redo og file)，前者是在内存中，后者在磁盘中。当事务提交之后会把所有修改信息都存到该日志文件中，用于在刷新脏页到磁盘，发生错误时，进行数据恢复使用。    </p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/redo log.png" alt="redo log"></p>
<h3 id="8-3-2-undo-log"><a href="#8-3-2-undo-log" class="headerlink" title="8.3.2.undo log"></a>8.3.2.undo log</h3><p>==解决事务的原子性==</p>
<p>回滚日志，用于记录数据被修改前的信息，作用包含两个:提供<strong>回滚</strong> 和 <strong>MVCC</strong>(多版本并发控制)。</p>
<p>undo log和redo log记录物理日志不一样，它是逻辑日志。可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。当执行rollback时，就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。</p>
<ul>
<li><p>undo log销毁：undo log在事务执行时产生，事务提交时，并不会立即删除undo log，因为这些日志可能还用于MVCC.</p>
</li>
<li><p>undo log存储：undo log采用段的方式进行管理和记录，存放在前面介绍的 rollback segment 回滚段中，内部包含1024个undo log segment。</p>
</li>
</ul>
<h3 id="8-3-3-MVCC⭐⭐⭐"><a href="#8-3-3-MVCC⭐⭐⭐" class="headerlink" title="8.3.3.MVCC⭐⭐⭐"></a>8.3.3.MVCC⭐⭐⭐</h3><h4 id="8-3-3-1-基本概念"><a href="#8-3-3-1-基本概念" class="headerlink" title="8.3.3.1.基本概念"></a>8.3.3.1.基本概念</h4><h5 id="当前读"><a href="#当前读" class="headerlink" title="当前读"></a>当前读</h5><p>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。对于我们日常的操作，如：select … lock in share mode(共享锁)， select … for updte、 update、 insert、delete(排他锁)都是一种当前读。</p>
<h5 id="快照读"><a href="#快照读" class="headerlink" title="快照读"></a>快照读</h5><p>简单的select(不加锁)就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。</p>
<ul>
<li>Read Committed：每次select，都生成一个快照读。</li>
<li>Repeatable Read：开启事务后第一个select语句才是快照读的地方</li>
<li>Serializable：快照读会退化为当前读。    </li>
</ul>
<h5 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h5><p>全称 Multi-Version Concurrency ontrol，<strong>多版本并发控制</strong>。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为MySQL实现MVCC提供了一个非阻塞读功能。MVCC的具体实现，还需要依赖于数据库记录中的三个隐式字段、undo log日志、readView。</p>
<h5 id="记录中的隐藏字段"><a href="#记录中的隐藏字段" class="headerlink" title="记录中的隐藏字段"></a>记录中的隐藏字段</h5><p><img src="http://cdn.leesin.fun/typora/s3/img/记录中的隐藏字段.png" alt="记录中的隐藏字段"></p>
<h5 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h5><p>回滚日志，在insert、update、delete的时候产生的便于数据回滚的日志。</p>
<p><strong>当insert的时候</strong>，产生的undo log日志只在回滚时需要，<strong>在事务提交后，可被立即删除</strong>。</p>
<p><strong>而update、delete的时候</strong>，产生的undo log日志<strong>不仅在回滚时需要</strong>，<strong>在快照读时也需要</strong>，不会立即被删除。</p>
<h5 id="undo-log版本链"><a href="#undo-log版本链" class="headerlink" title="undo log版本链"></a>undo log版本链</h5><p><img src="http://cdn.leesin.fun/typora/s3/img/undo log版本链.png" alt="undo log版本链"></p>
<p>不同事务或相同事务对同一条记录进行修改，会导致该记录的undo log生成一条记录版本链表，链表的头部是最新的旧记录，链表尾部是最早的旧记录。</p>
<h5 id="readview"><a href="#readview" class="headerlink" title="readview"></a>readview</h5><p>ReadView(读视图)是 <strong>快照读</strong> SQL执行时MVCC提取数据的依据，记录并维护系统当前活跃的事务(未提交的)id。<br>ReadView中包含了四个核心字段：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>m_ids</td>
<td>当前活跃的事务ID集合</td>
</tr>
<tr>
<td>min_trx_id</td>
<td>最小活跃事务ID</td>
</tr>
<tr>
<td>max_trx_id</td>
<td>预分配事务ID，当前最大事务ID+1（因为事务ID是自增的）</td>
</tr>
<tr>
<td>creator_trx_id</td>
<td>ReadView创建者的事务ID</td>
</tr>
</tbody>
</table>
</div>
<p><img src="http://cdn.leesin.fun/typora/s3/img/readView.png" alt="readView"></p>
<p>==不同的隔离级别，生成ReadView的时机不同：==</p>
<ul>
<li>==READ COMMITTED：在事务中每一次执行快照读时生成ReadView。==</li>
<li>==REPEATABLE READ：仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。==</li>
</ul>
<p>下面举例说明</p>
<p>举例1，read committed（可以看视频<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=145）">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=145）</a></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/readview举例之read committed1.png" alt="readview举例之read committed1"></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/readview举例之read committed2.png" alt="readview举例之read committed2"></p>
<p>举例2，repeatable read（可以看视频<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=146）">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=146）</a></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/readview举例之repeatable read.png" alt="readview举例之repeatable read"></p>
<h3 id="8-3-4-事务原理总结⭐⭐⭐"><a href="#8-3-4-事务原理总结⭐⭐⭐" class="headerlink" title="8.3.4.事务原理总结⭐⭐⭐"></a>8.3.4.事务原理总结⭐⭐⭐</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/事务原理总结.png" alt="事务原理总结"></p>
<h1 id="9-MySQL管理"><a href="#9-MySQL管理" class="headerlink" title="9.MySQL管理"></a>9.MySQL管理</h1><h2 id="9-1-系统数据库"><a href="#9-1-系统数据库" class="headerlink" title="9.1.系统数据库"></a>9.1.系统数据库</h2><p>Mysql数据库安装完成后，自带了一下四个数据库，具体作用如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>数据库</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>mysql</td>
<td>存储MySQL服务器正常运行所需要的各种信息 (时区、主从、用户、权限等)</td>
</tr>
<tr>
<td>information_schema</td>
<td>提供了访问数据库元数据的各种表和视图，包含数据库、表、字段类型及访问权限等</td>
</tr>
<tr>
<td>performance_schema</td>
<td>为MysQL服务器送行时状态提供了一个底层监控功能，主要用于收集数据库服务器性能参数</td>
</tr>
<tr>
<td>sys</td>
<td>包含了一系列方便DBA和开发人员利用 performance schema性能数据库进行性能调优和诊断的视图</td>
</tr>
</tbody>
</table>
</div>
<h2 id="9-2-常用工具"><a href="#9-2-常用工具" class="headerlink" title="9.2.常用工具"></a>9.2.常用工具</h2><h3 id="9-2-1-mysql"><a href="#9-2-1-mysql" class="headerlink" title="9.2.1.mysql"></a>9.2.1.mysql</h3><p>该mysql不是指mysql服务，而是指mysql的客户端工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法 :</span><br><span class="line">	mysql [options] [database]</span><br><span class="line">选项:</span><br><span class="line">    -u, --user=name    <span class="comment">#指定用户名</span></span><br><span class="line">    -p,--password[=namel    <span class="comment">#指定密码</span></span><br><span class="line">    -h, --host=name    <span class="comment">#指定服务器IP或域名</span></span><br><span class="line">    -P,--port=port    <span class="comment">#指定连接端口</span></span><br><span class="line">    -e,--execute=name    <span class="comment">#执行SQL语句并退出</span></span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">	mysql -hitachi102 -uroot -proot -P3306</span><br></pre></td></tr></table></figure>
<p>-e选项可以在Mysql客户端执行SQL语句，而不用连接到MyQL数据库再执行，对于一些批处理脚本，这种方式尤其方便。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot db01 -e<span class="string">&quot;select * from stu&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="9-2-2-mysqladmin"><a href="#9-2-2-mysqladmin" class="headerlink" title="9.2.2.mysqladmin"></a>9.2.2.mysqladmin</h3><p>mysqladmin 是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过帮助文档查看选项</span></span><br><span class="line">mysqladmin --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<h3 id="9-2-3-mysqlbinlog⭐⭐⭐"><a href="#9-2-3-mysqlbinlog⭐⭐⭐" class="headerlink" title="9.2.3.mysqlbinlog⭐⭐⭐"></a>9.2.3.mysqlbinlog⭐⭐⭐</h3><p>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到myslbinlog 日志管理工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">语法 :</span><br><span class="line">	mysqlbinlog [options] log-files1 ...</span><br><span class="line">选项 :</span><br><span class="line">	<span class="comment"># 指定数据库名称，只列出指定的数据库相关操作。</span></span><br><span class="line">    -d,--database=name</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 忽略掉日志中的前n行命令。</span></span><br><span class="line">    -o,--offset=</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将行事件（数据变更）重构为SQL语句</span></span><br><span class="line">    -v</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将行事件（数据变更）重构为SQL语句，并输出注释信息</span></span><br><span class="line">    -w</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将输出的文本格式日志输出到指定文件。</span></span><br><span class="line">    -r,--result-file=name</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示简单格式，省略掉一些信息。</span></span><br><span class="line">    -s, --short-form</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 指定日期间隔内的所有日志</span></span><br><span class="line">    --start-datatime=date1 --stop-datetime=date2</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 指定位置间隔内的所有日志。</span></span><br><span class="line">    --start-position=pos1 --stop-position=pos2</span><br></pre></td></tr></table></figure>
<p>使用举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入Linux</span></span><br><span class="line"><span class="comment"># 进入mysql日志文件存放的位置</span></span><br><span class="line"><span class="comment"># ll查看文件</span></span><br><span class="line"><span class="comment"># mysqlbinlog查看日志文件</span></span><br><span class="line">[root@itachi102 mysql]<span class="comment"># cd /var/lib/mysql</span></span><br><span class="line">[root@itachi102 mysql]<span class="comment"># ll</span></span><br><span class="line">[root@itachi102 mysql]<span class="comment"># mysqlbinlog binlog.000001</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="9-2-4-mysqlshow"><a href="#9-2-4-mysqlshow" class="headerlink" title="9.2.4.mysqlshow"></a>9.2.4.mysqlshow</h3><p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法 :</span><br><span class="line">	mysqlshow [options] [db_name[table_name[col_name]]]</span><br><span class="line">选项:</span><br><span class="line">	--count			<span class="comment"># 显示数据库及表的统计信息 (数据库，表 均可以不指定)</span></span><br><span class="line">	-i				<span class="comment"># 显示指定数据库或者指定表的状态信息</span></span><br></pre></td></tr></table></figure>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询每个数据库的表的数量及表中记录的数量</span></span><br><span class="line">mysqlshow -uroot -proot --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中每个表中的字段数，及行数</span></span><br><span class="line">mysqlshow -uroot -proot <span class="built_in">test</span> --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中book表的详细情况</span></span><br><span class="line">mysqlshow -uroot -proot <span class="built_in">test</span> book --count</span><br></pre></td></tr></table></figure>
<h3 id="9-2-5-mysqldump"><a href="#9-2-5-mysqldump" class="headerlink" title="9.2.5.mysqldump"></a>9.2.5.mysqldump</h3><p>mysqldump 客户端工具用备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SOL语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	mysqldump [options] db_name [tables]</span><br><span class="line">	mysqldump [options] --database/-B db1 [db2 db3...]</span><br><span class="line">	mysqldump [options] --all-databases/-A</span><br><span class="line"></span><br><span class="line">连接选项：</span><br><span class="line">	-u,--user=name			<span class="comment">#指定用户名</span></span><br><span class="line">	-p,--password[=name]	<span class="comment">#指定密码</span></span><br><span class="line">	-h,--host=name			<span class="comment">#指定服务器ip或域名</span></span><br><span class="line">	-P,--port=				<span class="comment">#指定连接端口</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出选项：</span><br><span class="line"></span><br><span class="line">	<span class="comment">#在每个数据库创建语句前加上 drop database 语句</span></span><br><span class="line">	--add-drop-database		</span><br><span class="line">	<span class="comment">#在每个表创建语句前加上 drop table 语句，默认开启 ;不开启(--skip-add-drop-table)</span></span><br><span class="line">	--add-drop-table</span><br><span class="line">    <span class="comment">#不包含数据库的创建语句</span></span><br><span class="line">	-n,--no-create-db</span><br><span class="line">	<span class="comment">#不包含数据表的创建语句</span></span><br><span class="line">	-t,--no-create-info</span><br><span class="line">	<span class="comment">#不包含数据</span></span><br><span class="line">	-d --no-data</span><br><span class="line">	<span class="comment">#自动生成两个文件:一个.sql文件，创建表结构的语句;一个.txt文件，数据文件</span></span><br><span class="line">	-T,--tab=name</span><br></pre></td></tr></table></figure>
<p>使用举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份数据库db01</span></span><br><span class="line">mysqldump -uroot -proot db01 &gt; db01.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份数据库db01，只备份表结构不备份数据</span></span><br><span class="line">mysqldump -uroot -proot -d db01 &gt; db02.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份数据库db01下的score表，并且将表结构输出为.sql文件，将数据输出为.txt文件</span></span><br><span class="line"><span class="comment"># 并指定输出的目录为/var/lib/mysql-files/</span></span><br><span class="line">mysqldump -uroot -proot -T /var/lib/mysql-files/ db01 score</span><br></pre></td></tr></table></figure>
<h3 id="9-2-6-mysqlimport"><a href="#9-2-6-mysqlimport" class="headerlink" title="9.2.6.mysqlimport"></a>9.2.6.mysqlimport</h3><p>mysqlimport是客户端数据导入工具，用来导入mysqldump 加-T参数后导出的文本文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	mysqlimport [options] db_name textfile1 [textfile2 ...]</span><br><span class="line">示例：</span><br><span class="line">	mysqlimport -uroot -proot db01 /var/lib/mysql-files/score.txt</span><br><span class="line">	<span class="comment"># 注意：文件名就是表名</span></span><br></pre></td></tr></table></figure>
<h3 id="9-2-7-source"><a href="#9-2-7-source" class="headerlink" title="9.2.7.source"></a>9.2.7.source</h3><p>如果需要导入sql文件，可以使用source指令，但是这个指令要进入mysql中的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">	<span class="built_in">source</span> /.../xxx.sql</span><br></pre></td></tr></table></figure>
<h1 id="10-运维"><a href="#10-运维" class="headerlink" title="10.运维"></a>10.运维</h1><h2 id="10-1-日志⭐⭐⭐"><a href="#10-1-日志⭐⭐⭐" class="headerlink" title="10.1.日志⭐⭐⭐"></a>10.1.日志⭐⭐⭐</h2><h3 id="10-1-1-错误日志"><a href="#10-1-1-错误日志" class="headerlink" title="10.1.1.错误日志"></a>10.1.1.错误日志</h3><p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。<strong>当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</strong></p>
<p>该日志是默认开启的，默认存放目录 <code>/var/log/</code> ，默认的日志文件名为 <code>mysqld.log</code> 。</p>
<p>进入mysql查看日志位置:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_error&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> log_error     <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mysqld.log <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br></pre></td></tr></table></figure>
<p>例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -50 /var/log/mysqld.log </span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysqld.log </span><br></pre></td></tr></table></figure>
<h3 id="10-1-2-二进制日志"><a href="#10-1-2-二进制日志" class="headerlink" title="10.1.2.二进制日志"></a>10.1.2.二进制日志</h3><p>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但不包括数据查询(SELECT、SHOW)语句。</p>
<p>作用：</p>
<ol>
<li><p><strong>灾难时的数据恢复</strong></p>
</li>
<li><p><strong>MSQL的主从复制</strong></p>
</li>
</ol>
<p>在MySL8版本中，默认二进制日志是开启着的，涉及到的参数如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>binlog       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>binlog.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>在linux看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@itachi102 mysql-files]<span class="comment"># cd /var/lib/mysql/</span></span><br><span class="line">[root@itachi102 mysql]<span class="comment"># ll</span></span><br><span class="line">-rw-r-----. 1 mysql mysql      998 3月  10 17:43 binlog.000001</span><br><span class="line">-rw-r-----. 1 mysql mysql     9824 3月  12 18:28 binlog.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql       32 3月  10 17:44 binlog.index</span><br><span class="line">[root@itachi102 mysql]<span class="comment"># cat binlog.index </span></span><br><span class="line">./binlog.000001</span><br><span class="line">./binlog.000002</span><br></pre></td></tr></table></figure>
<h4 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h4><p>MySQL服务器中提供了多种格式来记录二进制日志:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>日志格式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>STATEMENT</td>
<td>基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志文件中。</td>
</tr>
<tr>
<td>ROW</td>
<td>基于行的日志记录，记录的是每一行的数据变更。(默认)</td>
</tr>
<tr>
<td>MIXED</td>
<td>混合了STATEMENT和ROW两种格式，默认采用STATEMENT，在某些特殊情况下会自动切换为ROW进行记录。</td>
</tr>
</tbody>
</table>
</div>
<p>查看当前mysql版本中，默认的日志格式是哪种</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog_format&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> binlog_format <span class="operator">|</span> <span class="type">ROW</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h4><p>前面有笔记  6.2.3.mysqlbinlog</p>
<h4 id="日志删除"><a href="#日志删除" class="headerlink" title="日志删除"></a>日志删除</h4><p>对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间。可以通过以下几种方式清理日志:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 删除全部binlog日志，删除之后，日志编号将会从binlog<span class="number">.000001</span>开始编号</span><br><span class="line">reset master</span><br><span class="line"></span><br><span class="line"># 删除<span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>编号之前的所有日志</span><br><span class="line">purge master logs <span class="keyword">to</span> <span class="string">&#x27;binlog.******&#x27;</span></span><br><span class="line"></span><br><span class="line"># 删除日志为&quot;yyyy-mm-dd hh24:mi:ss&quot;之前产生的所有日志</span><br><span class="line">purge master logs before <span class="string">&#x27;yyyy-mm-dd hh24:mi:ss&#x27;</span></span><br></pre></td></tr></table></figure>
<p>如果不手动删除，mysql也会在一定时间内删除。</p>
<p>查看过期时间的语句：（默认是30天的过期时间）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog_expire_logs_seconds&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name              <span class="operator">|</span> <span class="keyword">Value</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> binlog_expire_logs_seconds <span class="operator">|</span> <span class="number">2592000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>当然我们也可以在mysql配置文件中手动修改二进制文件的过期时间。</p>
<h3 id="10-1-3-查询日志"><a href="#10-1-3-查询日志" class="headerlink" title="10.1.3.查询日志"></a>10.1.3.查询日志</h3><p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。默认情况下，查询日志是未开启的。如果需要开启查询日志，可以去 <code>/etc/my.cnf</code>  末尾追加 <code>general_log=1</code>，然后重启服务。</p>
<p>查看默认情况的语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%general%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> general_log      <span class="operator">|</span> OFF                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> general_log_file <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>itachi102.log <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="10-1-4-慢查询日志"><a href="#10-1-4-慢查询日志" class="headerlink" title="10.1.4.慢查询日志"></a>10.1.4.慢查询日志</h3><p>请查看2.6.2.慢查询日志</p>
<h2 id="10-2-主从复制"><a href="#10-2-主从复制" class="headerlink" title="10.2.主从复制"></a>10.2.主从复制</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>主从复制是指将主数据库的DDL和 DML 操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。</p>
<p>MySQL支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库，实现链状复制。</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li><p>主库出现问题，可以快速切换到从库提供服务</p>
</li>
<li><p>实现读写分离，降低主库的访问压力。</p>
</li>
<li><p>可以在从库中执行备份，以避免备份期间影响主库服务。</p>
</li>
</ol>
<h3 id="原理⭐⭐⭐"><a href="#原理⭐⭐⭐" class="headerlink" title="原理⭐⭐⭐"></a>原理⭐⭐⭐</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/主从复制原理.png" alt="主从复制原理"></p>
<p>从上图来看，复制分成三步:</p>
<ol>
<li><p>Master 主库在事务提交时，会把数据变更记录在二进制日志文件 Binlog 中。</p>
</li>
<li><p>从库读取主库的二进制日志文件Binlog，写入到从库的中继日志 Relay Log。</p>
</li>
<li><p>slave重做中继日志中的事件，将改变反映它自己的数据。</p>
</li>
</ol>
<h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><p>准备两台服务器：itachi102和itachi103</p>
<p>itachi102作为主库，itachi103作为从库</p>
<h5 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h5><ol>
<li>修改<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，默认为1</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#是否只读,1 代表只读,0代表读写</span></span><br><span class="line"><span class="attr">read-only</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#忽略的数据,指不需要同步的数据库</span></span><br><span class="line"><span class="comment">#binlog-ignore-db=mysql</span></span><br><span class="line"><span class="comment">#指定同步的数据库</span></span><br><span class="line"><span class="comment">#binlog-do-db=db01</span></span><br></pre></td></tr></table></figure>
<ol>
<li>重启服务</li>
<li>登录mysql，创建从库连接主库用的远程连接的账号，并授予主从复制权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建itachi用户，该用户可在任意主机连接该mysql服务</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"># 为<span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>用户分配主从复制权限</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过指令，查看二进制日志坐标</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File          <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000006</span> <span class="operator">|</span>      <span class="number">663</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>字段含义说明:</p>
<ul>
<li>File：从哪个日志文件开始推送日志文件</li>
<li>Position：从哪个位置开始推送日志</li>
<li>Binlog_ignore_db：指定不需要同步的数据库</li>
</ul>
<h5 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h5><ol>
<li>修改<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，和主库不一样即可</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">2</span></span><br><span class="line"><span class="comment">#是否只读,1 代表只读,0代表读写</span></span><br><span class="line"><span class="attr">read-only</span>=<span class="string">1</span></span><br></pre></td></tr></table></figure>
<ol>
<li>如果是克隆过来的机器，需要修改uuid</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 登录mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> uuid();</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> uuid()                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> b33057ff<span class="operator">-</span>bec6<span class="number">-11</span>eb<span class="operator">-</span>ad94<span class="number">-000</span>c29af6856 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">————————————————</span><br><span class="line"></span><br><span class="line"># 退出mysql，去修改uuid</span><br><span class="line">vim <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>auto.cnf</span><br><span class="line"></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>重启服务</li>
<li>登录mysql，设置主库配置</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;itachi102&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;itachi&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;binlog.000006&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">663</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>开启同步操作</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">8.0</span><span class="number">.22</span>之后</span><br><span class="line"><span class="keyword">start</span> replica; </span><br><span class="line"></span><br><span class="line"># <span class="number">8.0</span><span class="number">.22</span>.之前</span><br><span class="line"><span class="keyword">start</span> slave; </span><br></pre></td></tr></table></figure>
<ol>
<li>查看主从同步状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">8.0</span><span class="number">.22</span>之后</span><br><span class="line"><span class="keyword">show</span> replica status\G; </span><br><span class="line"></span><br><span class="line"># <span class="number">8.0</span><span class="number">.22</span>.之前</span><br><span class="line"><span class="keyword">show</span> slave status\G; </span><br></pre></td></tr></table></figure>
<p>主要看两个字段，如果这两个字段为YES，说明就成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><ol>
<li>在主库中创建数据库、表，并插入数据</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database db01;</span><br><span class="line">use db01;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_user(</span><br><span class="line">	id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">primary</span> key <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	sex <span class="type">varchar</span>(<span class="number">1</span>)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="keyword">null</span>,<span class="string">&#x27;Trigger&#x27;</span>,<span class="string">&#x27;0&#x27;</span>),(<span class="keyword">null</span>,<span class="string">&#x27;Dawn&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>
<ol>
<li>去从库查询数据，验证主从是否同步</li>
</ol>
<h2 id="10-3-分库分表"><a href="#10-3-分库分表" class="headerlink" title="10.3.分库分表"></a>10.3.分库分表</h2><h3 id="10-3-1-拆分方式"><a href="#10-3-1-拆分方式" class="headerlink" title="10.3.1.拆分方式"></a>10.3.1.拆分方式</h3><h3 id="10-3-2-MyCat架构"><a href="#10-3-2-MyCat架构" class="headerlink" title="10.3.2.MyCat架构"></a>10.3.2.MyCat架构</h3><p><img src="http://cdn.leesin.fun/typora/s3/img/mycat架构.png" alt="mycat架构"></p>
<h3 id="10-3-3-入门"><a href="#10-3-3-入门" class="headerlink" title="10.3.3.入门"></a>10.3.3.入门</h3><h5 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h5><p>由于 tb_order 表中数据量很大，磁盘 IO 及容量都到达了瓶颈，现在需要对 tb_order 表进行数据分片，分为三个数据节点，每一个节点主机位于不同的服务器上，具体的结构参考下图：</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/mycat入门1.png" alt="mycat入门1" style="zoom:50%;"></p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><div class="table-container">
<table>
<thead>
<tr>
<th>服务器</th>
<th>安装软件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>itachi103</td>
<td>JDK和Mycat</td>
<td>Mycat中间件服务器</td>
</tr>
<tr>
<td>itachi103</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
<tr>
<td>itachi104</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
<tr>
<td>itachi105</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
</tbody>
</table>
</div>
<p>然后进入itachi103的目录<code>/usr/local/mycat/lib</code></p>
<p>将mysql驱动包换成8版本的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/mycat/lib</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f mysql-connector-java-5.1.35.jar </span><br><span class="line"></span><br><span class="line">然后将mysql-connector-java-8.0.22.jar上传至此目录下</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 777 mysql-connector-java-8.0.22.jar </span><br></pre></td></tr></table></figure>
<h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><p>分别在3台mysql服务器中创建一个空的数据库，名字为<code>db01</code></p>
<h5 id="配置schema-xml"><a href="#配置schema-xml" class="headerlink" title="配置schema.xml"></a>配置schema.xml</h5><p>位于<code>/usr/local/mycat/conf/schema.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;DB01&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;TB_ORDER&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi103:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi104:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi105:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里配置的是，逻辑库逻辑表相关信息</p>
</blockquote>
<h5 id="配置server-xml"><a href="#配置server-xml" class="headerlink" title="配置server.xml"></a>配置server.xml</h5><p>修改server.xml相应的标签为如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里配置的是，登录mycat的账号密码</p>
</blockquote>
<h5 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入mycat目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/mycat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动，端口号默认为8066</span></span><br><span class="line">bin/mycat start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否启动成功，如果出现MyCAT Server startup successfully.则成功了</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/wrapper.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">bin/mycat stop</span><br></pre></td></tr></table></figure>
<h5 id="登录mycat"><a href="#登录mycat" class="headerlink" title="登录mycat"></a>登录mycat</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hitachi103 -P8066 -uroot -p123456 --default_auth=mysql_native_password</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> DATABASE <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> DB01     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use DB01;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables <span class="keyword">in</span> DB01 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> tb_order       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时三台服务器的mysql都还没有表结构，上面查询出来的只是mycat中的逻辑表结构</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_order(</span><br><span class="line">    id <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    title <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">primary</span> key(id)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<p>执行创建表后，三台服务器才真正的创建了表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;godds1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;godds2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;godds3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">1000000</span>,<span class="string">&#x27;godds1000000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">10000000</span>,<span class="string">&#x27;godds10000000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_order(id,title) <span class="keyword">values</span>(<span class="number">10000001</span>,<span class="string">&#x27;godds10000001&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>插入数据后，根据分片规则（schema.xml配置），水平拆分给三台服务器存放数据</p>
<p>itachi103</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/itachi103.png" alt="itachi103"></p>
<p>itachi104</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/itachi104.png" alt="itachi104"></p>
<p>itachi105</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/itachi105.png" alt="itachi105"></p>
<h3 id="10-3-4-MyCat配置"><a href="#10-3-4-MyCat配置" class="headerlink" title="10.3.4.MyCat配置"></a>10.3.4.MyCat配置</h3><h4 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h4><p>schema.xml作为MyCat中最重要的配置文件之一,涵盖了MyCat的逻辑库、逻辑表、分片规则、分片节点及数据源的配置。</p>
<p>主要包含以下三组标签:</p>
<p><strong>schema标签</strong></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/schema.xml的sechema标签.png" alt="schema.xml的sechema标签"></p>
<p>schema 标签用于定义 Mycat实例中的逻辑库，一个Mycat实例中，可以有多个逻辑库，可以通过 schema 标签来划分不同的逻辑库。</p>
<p>Mycat中的逻辑库的概念，等同于MySQL中的database概念，需要操作某个逻辑库下的表时，也需要切换逻辑库(use xxx)。</p>
<blockquote>
<ul>
<li>name：指定自定义的逻辑库库名</li>
<li><p>sqlMaxLimit：如果未指定limit进行查询，列表查询模式查询多少条记录</p>
</li>
<li><p>table标签里面的属性：</p>
<ul>
<li>name：定义逻辑表表名，在该逻辑库下唯一</li>
<li>dataNode：定义逻辑表所属的dataNode，该属性需要与dataNode标签中name对应</li>
<li>rule：分片规则的名字，分片规则名字是在rule.xml中定义的</li>
<li>primaryKey：逻辑表对应真实表的主键</li>
<li>type：逻辑表的类型，目前逻辑表只有全局表和普通表，如果未配置，就是普通表；全局表，配置为 global</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>datanode标签</strong></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/schema.xml的dataNode标签.png" alt="schema.xml的dataNode标签"></p>
<p>dataNode 标签中定义了 MyCat 中的数据节点，也就是我们通常说的数据分片。一个 dataNode 标签就是一个独立的数据分片。</p>
<blockquote>
<ul>
<li>name：定义数据节点名称</li>
<li>dataHost：数据库实例主机名称，引用自 dataHost标签中name属性</li>
<li>database：定义分片的数据库</li>
</ul>
</blockquote>
<p><strong>datahost标签</strong></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/schema.xml的dataHost标签.png" alt="schema.xml的dataHost标签"></p>
<p>该标签在 MyCat 逻辑库中作为底层标签存在，直接定义了具体的数据库实例、读写分离、心跳语句。</p>
<blockquote>
<ul>
<li>name：唯一标识，供上层标签使用</li>
<li>maxCon/minCon：最大连接数/最小连接数</li>
<li>balance：负载均衡策略，取值 0,1,2,3</li>
<li>writeType：写操作分发方式，取值0,1</li>
<li>switchType：设置是否自动切换，取值-1,1</li>
<li>dbDriver：数据库驱动，支持 native、jdbc</li>
</ul>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>balance参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>0（默认值）</td>
<td>不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost与备用的writeHost都参与select语句的负载均衡（主要针对于双主双从模式）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost，readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行。writeHost只负担写压力，不负担读压力</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">writeType参数值</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">写操作转发到第一个writeHost，第一个挂了，切换到第二个</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">写操作随机分发到配置的writeHost</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">switch参数值</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-1</td>
<td style="text-align:center">不自动切换</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">当writeHost1挂了之后，自动切换至writeHost2上</td>
</tr>
</tbody>
</table>
</div>
<p><strong>总结</strong></p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/schema.xml总结.png" alt="schema.xml总结"></p>
<h4 id="rule-xml"><a href="#rule-xml" class="headerlink" title="rule.xml"></a>rule.xml</h4><p>rule.xml 中定义所有拆分表的规则，在使用过程中可以灵活的使用分片算法，或者对同一个分片算法使用不同的参数，它让分片过程可配置化。主要包含两类标签：tableRule、Function。</p>
<p>以rang-long为例：</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/rule.xml举例之rang-long策略.png" alt="rule.xml举例之rang-long策略"></p>
<h4 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h4><p>server.xml 配置文件包含了 MyCat 的系统配置信息，主要有两个重要的标签：system、user。</p>
<ul>
<li>system标签</li>
</ul>
<p>​    自己打开server.xml来看，里面有注释</p>
<ul>
<li>user标签</li>
</ul>
<p><img src="http://cdn.leesin.fun/typora/s3/img/mycat的server.xml的user标签.png" alt="mycat的server.xml的user标签"></p>
<p>注意，如果配置多个逻辑库，逗号隔开，如下：⭐⭐⭐</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01,DB02,DB03,DB04<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="10-3-5-垂直分库示例"><a href="#10-3-5-垂直分库示例" class="headerlink" title="10.3.5.垂直分库示例"></a>10.3.5.垂直分库示例</h3><p>在业务系统中，涉及以下表结构，但是由于用户与订单每天都会产生大量的数据，单台服务器的数据存储及处理能力是有限的，可以对数据库表进行拆分。图的左边原有的数据库表，图的右边是垂直分库后的情况。</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/垂直分库示例-167869852638120.png" alt="垂直分库示例"></p>
<p><strong>准备</strong></p>
<p>在三台服务器中都创建数据库<code>shopping</code></p>
<p><strong>配置</strong></p>
<p>schema.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;SHOPPING&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_base&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_brand&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_cat&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_desc&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_master&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;order_id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_pay_log&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;out_trade_no&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_address&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_provinces&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_city&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_region&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi103:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi104:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi105:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING<span class="tag">&lt;/<span class="name">property</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>上传sql文件至itachi103的<code>/opt/sql</code></strong></p>
<p><strong>在itachi103登录mycat</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hitachi103 -P8066 -uroot -p123456 --default_auth=mysql_native_password</span><br></pre></td></tr></table></figure>
<p><strong>然后在里面运行sql文件</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use SHOPPING;</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>home<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>shopping<span class="operator">-</span>table.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>home<span class="operator">/</span><span class="keyword">sql</span><span class="operator">/</span>shopping<span class="operator">-</span>insert.sql</span><br></pre></td></tr></table></figure>
<p><strong>在datagrip查看每一个Mysql服务器是否有响应数据</strong></p>
<p><strong>测试多表联查</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ua.user_id, ua.contact, p.province, c.city, r.area, ua.address</span><br><span class="line"><span class="keyword">from</span> tb_user_address ua, tb_areas_provinces p, tb_areas_city c, tb_areas_region r</span><br><span class="line"><span class="keyword">where</span> ua.province_id<span class="operator">=</span>p.provinceid <span class="keyword">and</span> ua.city_id<span class="operator">=</span>c.cityid <span class="keyword">and</span> ua.town_id<span class="operator">=</span>r.areaid;</span><br></pre></td></tr></table></figure>
<p>上述sql在itachi105上是能成功的，因为上述sql使用的表在itachi105上都有，然后在mycat中执行也是能成功的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> order_id, payment, receiver, province, city, area</span><br><span class="line"><span class="keyword">from</span> tb_order_master o, tb_areas_provinces p, tb_areas_city c, tb_areas_region r</span><br><span class="line"><span class="keyword">where</span> o.receiver_province<span class="operator">=</span>p.provinceid <span class="keyword">and</span> o.receiver_city<span class="operator">=</span>c.cityid <span class="keyword">and</span> o.receiver_region<span class="operator">=</span>r.areaid;</span><br></pre></td></tr></table></figure>
<p>上述语句在mycat中执行报错 <code>invalid route in sql, multi tables found but datanode has no intersection</code> ，原因是 <code>tb_order_master</code> 表和其他表不属于同一个dataNode中。</p>
<p>​    </p>
<p><strong>全局表demo</strong></p>
<p>因为有这样的需求，所以我们可以把<code>tb_areas_provinces</code>， <code>tb_areas_city</code>， <code>tb_areas_region</code> 这三个表设置为全局表。这样操作后，三台mysql服务器中都会含有这三个表。</p>
<p>步骤：停掉mycat  -&gt; 去data grip先将三个mysql中的shopping数据库的表都删除掉 -&gt; 重复上述步骤，仅仅是将配置文件修改一下：</p>
<p>schema.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_provinces&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_city&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_region&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在mycat中测试，就能成功执行上述两条sql了。</p>
<h2 id="10-4-读写分离"><a href="#10-4-读写分离" class="headerlink" title="10.4.读写分离"></a>10.4.读写分离</h2><p>MyCat的schema.xml中的dataHost标签的balance属性</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>balance参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>0（默认值）</td>
<td>不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost与备用的writeHost都参与select语句的负载均衡（主要针对于双主双从模式）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost，readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行。writeHost只负担写压力，不负担读压力</td>
</tr>
</tbody>
</table>
</div>
<h3 id="10-4-1-一主一从读写分离"><a href="#10-4-1-一主一从读写分离" class="headerlink" title="10.4.1.一主一从读写分离"></a>10.4.1.一主一从读写分离</h3><ol>
<li>准备好一主一从，itachi106为主库，itachi107为从库，并且在主库安装好MyCat</li>
<li>去主库执行sql</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database itachi;</span><br><span class="line"></span><br><span class="line">use itachi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_user(</span><br><span class="line">	id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	sex <span class="type">varchar</span>(<span class="number">1</span>),</span><br><span class="line">	<span class="keyword">primary</span> key (id)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Trigger&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Dawn&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>mycat配置</li>
</ol>
<p>schema.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;ITACHI_RW&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itachi&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi106:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;slave&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi107:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITACHI_RW<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITACHI_RW<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>登录mycat测试</li>
</ol>
<p>在itachi107从库中修改表中的某项数据，然后去mycat中查看，结果查看的数据一直是itachi107的数据，多试几次还是这样，说明读的时候是去从库读取的。</p>
<p>在mycat中插入一行数据，但是在itachi106主库和itachi107主库都能查得到这行新数据，说明写数据是在主库中进行的，因为如果在从库中写入是不会同步到主库的。</p>
<p><strong>问题：主节点Master宕机之后，业务系统就只能够读，而不能写入数据了。</strong></p>
<h3 id="10-4-2-双主双从读写分离"><a href="#10-4-2-双主双从读写分离" class="headerlink" title="10.4.2.双主双从读写分离"></a>10.4.2.双主双从读写分离</h3><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>一个主机 Master1 用于处理所有写请求，它的从机 Slave1 和另一台主机 Master2 还有它的从机 Slave2 负责所有读请求。当Master1主机宕机后，Master2 主机负责写请求，Master1、Master2 互为备机。架构图如下：</p>
<p><img src="http://cdn.leesin.fun/typora/s3/img/双主双从.png" alt="双主双从"></p>
<h5 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h5><p>准备5台服务器</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">编号</th>
<th style="text-align:center">主机</th>
<th style="text-align:center">预装软件</th>
<th style="text-align:center">角色</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">itachi108</td>
<td style="text-align:center">mycat、mysql</td>
<td style="text-align:center">mycat中间件服务器</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">itachi109</td>
<td style="text-align:center">mysql</td>
<td style="text-align:center">master1</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">itachi110</td>
<td style="text-align:center">mysql</td>
<td style="text-align:center">slave1</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">itachi111</td>
<td style="text-align:center">mysql</td>
<td style="text-align:center">maste2</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">itachi112</td>
<td style="text-align:center">mysql</td>
<td style="text-align:center">slave2</td>
</tr>
</tbody>
</table>
</div>
<p>如果是克隆过来的机器，需要修改每台mysql的uuid，确保不同</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 登录mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> uuid();</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> uuid()                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> b33057ff<span class="operator">-</span>bec6<span class="number">-11</span>eb<span class="operator">-</span>ad94<span class="number">-000</span>c29af6856 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">————————————————</span><br><span class="line"></span><br><span class="line"># 退出mysql，去修改uuid</span><br><span class="line">vim <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>auto.cnf</span><br><span class="line"></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="搭建-1"><a href="#搭建-1" class="headerlink" title="搭建"></a>搭建</h5><p>主库配置（Master1-itachi109）</p>
<ol>
<li>修改配置文件<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，默认为1</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"># 指定同步的数据库</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db01</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db02</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db03</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当当前节点在作为从数据库的时候，有写入操作也要更新二进制日志文件</span></span><br><span class="line"><span class="attr">log-slave-updates</span></span><br></pre></td></tr></table></figure>
<ol>
<li>重启mysql服务</li>
<li>登录mysql，创建从库连接主库用的远程连接的账号，并授予主从复制权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建itachi用户，该用户可在任意主机连接该mysql服务</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"># 为<span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>用户分配主从复制权限</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过指令，查看二进制日志坐标</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure>
<p>主库配置（Master2-itachi111）</p>
<ol>
<li>修改配置文件<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，默认为1</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定同步的数据库</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db01</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db02</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db03</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 当当前节点在作为从数据库的时候，有写入操作也要更新二进制日志文件</span></span><br><span class="line"><span class="attr">log-slave-updates</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>重启mysql服务</p>
</li>
<li><p>登录mysql，创建从库连接主库用的远程连接的账号，并授予主从复制权限</p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建itachi用户，该用户可在任意主机连接该mysql服务</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"># 为<span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>用户分配主从复制权限</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;itachi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过指令，查看二进制日志坐标</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure>
<p>从库配置（Slave1-itachi110）</p>
<ol>
<li>修改配置文件<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，默认为1</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>
<ol>
<li>重启mysql服务</li>
<li>登录mysql，设置主库配置</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;itachi109&#x27;</span>,maaster_user<span class="operator">=</span><span class="string">&#x27;itachi&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;binlog.000006&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">663</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>开启同步操作</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> slave; </span><br></pre></td></tr></table></figure>
<ol>
<li>查看主从同步状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status\G; </span><br></pre></td></tr></table></figure>
<p>主要看两个字段，如果这两个字段为YES，说明就成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<p>从库配置（Slave2-itachi112）</p>
<ol>
<li>修改配置文件<code>/etc/my.cnf</code></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql服务ID，保证整个集群环境中唯一，取值范围: 1 - 2^32-1，默认为1</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">4</span></span><br></pre></td></tr></table></figure>
<ol>
<li>重启mysql服务</li>
<li>登录mysql，设置主库配置</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;itachi111&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;itachi&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;binlog.000007&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">663</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>开启同步操作</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> slave; </span><br></pre></td></tr></table></figure>
<ol>
<li>查看主从同步状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status\G; </span><br></pre></td></tr></table></figure>
<p>主要看两个字段，如果这两个字段为YES，说明就成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<p>两台主库相互复制</p>
<p>Master1复制Master2，Master2复制Master1</p>
<p>在itachi109，即Master1中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;itachi111&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;itachi&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;binlog.000007&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">663</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span> slave; </span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> slave status\G; </span><br></pre></td></tr></table></figure>
<p>在itachi111，即Master2中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;itachi109&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;itachi&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;root&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;binlog.000006&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">663</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span> slave; </span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> slave status\G; </span><br></pre></td></tr></table></figure>
<h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><p>在Datagrip中，Master1执行创建数据库和表，看看M2和S1和S2是否同步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database db01;</span><br><span class="line"></span><br><span class="line">use db01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_user(</span><br><span class="line">	id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	sex <span class="type">varchar</span>(<span class="number">1</span>),</span><br><span class="line">	<span class="keyword">primary</span> key (id)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后Master2执行插入数据，看看是否同步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use db01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;Trigger&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;Dawn&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;Jack Ma&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;Coco&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id,name,sex) <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">&#x27;Jerry&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>如果测试通过，双主双从搭建完成</p>
<h5 id="搭建读写分离——MyCat"><a href="#搭建读写分离——MyCat" class="headerlink" title="搭建读写分离——MyCat"></a>搭建读写分离——MyCat</h5><p>schema.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;ITACHI_RW2&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi109:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;slave1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi110:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi111:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;slave2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://itachi112:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> &gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITACHI_RW2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITACHI_RW2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="启动mycat"><a href="#启动mycat" class="headerlink" title="启动mycat"></a>启动mycat</h5><h5 id="登录mycat-1"><a href="#登录mycat-1" class="headerlink" title="登录mycat"></a>登录mycat</h5><h5 id="测试主从复制"><a href="#测试主从复制" class="headerlink" title="测试主从复制"></a>测试主从复制</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在mycat中插入数据，然后去datagrip看四个mysql是否都有相应数据</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user <span class="keyword">value</span>(<span class="number">7</span>,<span class="string">&#x27;jackk&#x27;</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h5 id="测试高可用"><a href="#测试高可用" class="headerlink" title="测试高可用"></a>测试高可用</h5><ol>
<li><p>停掉master1的mysql服务</p>
</li>
<li><p>在mycat中测试插入一行数据</p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> tb_user <span class="keyword">value</span>(<span class="number">8</span>,<span class="string">&#x27;jackk&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"> OK<span class="operator">!</span></span><br></pre></td></tr></table></figure>
<ol>
<li>去datagrip发现M1连接不上，S1没新数据（因为M1挂了），M2和S2都有新数据。并且此时的读请求也不会去s1中执行了，指挥在m2和s2中读取数据。</li>
<li>重新启动M1的mysql服务，再去datagrip查看M1，自动把新数据同步过来了，且m1和s1恢复工作状态。（热插拔？）</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://leesin9527.github.io">leesin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://leesin9527.github.io/post/1.html">https://leesin9527.github.io/post/1.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://leesin9527.github.io" target="_blank">leesin</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.leesin.fun/hexo/article/1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/4.html" title="Linux"><img class="cover" src="http://cdn.leesin.fun/hexo/article/4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux</div></div></a></div><div class="next-post pull-right"><a href="/post/6.html" title="dp"><img class="cover" src="http://cdn.leesin.fun/hexo/article/6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">dp</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.leesin.fun/hexo/avatar.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="avatar"/></div><div class="author-info__name">leesin</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/leesin9527" target="_blank" title="Github"><i class="iconfont icon-github"></i></a><a class="social-icon" href="mailto:uchihazed@qq.com" target="_blank" title="Email"><i class="iconfont icon-email"></i></a><a class="social-icon" href="tencent://message/?uin=2269196662&amp;Site=Sambow&amp;Menu=yes" target="_blank" title="QQ"><i class="iconfont icon-qq"></i></a><a class="social-icon" href="https://space.bilibili.com/350235279?spm_id_from=333.999.0.0" target="_blank" title="B站"><i class="iconfont icon-bilibili"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%85%B6%E4%BB%96"><span class="toc-number">1.</span> <span class="toc-text">1.其他</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-DDL%EF%BC%88%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89%E8%AF%AD%E8%A8%80%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.DDL（数据定义语言）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-DML%EF%BC%88%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E8%AF%AD%E8%A8%80%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">1.2.DML（数据操作语言）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-DQL%EF%BC%88%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">1.3.DQL（数据查询语言）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-DCL%EF%BC%88%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">1.4.DCL（管理用户）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">2.事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%BA%8B%E5%8A%A1%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.事务简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.事务操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E4%BA%8B%E5%8A%A1%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7ACID%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">2.3.</span> <span class="toc-text">2.3.事务四大特性ACID⭐⭐⭐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.并发事务问题⭐⭐⭐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">2.5.</span> <span class="toc-text">2.5.事务的隔离级别⭐⭐⭐</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">3.MySQL体系结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">4.</span> <span class="toc-text">4.存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-InnoDB-%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.InnoDB 逻辑存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-InnoDB%E5%92%8CMyISAM%E5%92%8CMemory%E5%AF%B9%E6%AF%94"><span class="toc-number">4.2.</span> <span class="toc-text">4.2.InnoDB和MyISAM和Memory对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">4.3.</span> <span class="toc-text">4.3.存储引擎的选择</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%B4%A2%E5%BC%95"><span class="toc-number">5.</span> <span class="toc-text">5.索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">5.1.</span> <span class="toc-text">5.1.优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="toc-number">5.2.</span> <span class="toc-text">5.2.索引结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1.二叉搜索树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-B-Tree%EF%BC%88%E5%A4%9A%E8%B7%AF%E5%B9%B3%E8%A1%A1%E6%9F%A5%E6%89%BE%E6%A0%91%EF%BC%89"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2.B-Tree（多路平衡查找树）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-B-Tree"><span class="toc-number">5.2.3.</span> <span class="toc-text">5.2.3.B+Tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-MySQL%E7%9A%84B-Tree"><span class="toc-number">5.2.4.</span> <span class="toc-text">5.2.4.MySQL的B+Tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-5-Hash"><span class="toc-number">5.2.5.</span> <span class="toc-text">5.2.5.Hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-6-%E9%9D%A2%E8%AF%95%E9%A2%98%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.2.6.</span> <span class="toc-text">5.2.6.面试题⭐⭐⭐</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="toc-number">5.3.</span> <span class="toc-text">5.3.索引分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E8%A1%A8%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.3.0.0.1.</span> <span class="toc-text">回表⭐⭐⭐</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">5.4.</span> <span class="toc-text">5.4.思考题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E7%B4%A2%E5%BC%95%E8%AF%AD%E6%B3%95"><span class="toc-number">5.5.</span> <span class="toc-text">5.5.索引语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E7%B4%A2%E5%BC%95%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">5.6.</span> <span class="toc-text">5.6.索引性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1-%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E9%A2%91%E6%AC%A1"><span class="toc-number">5.6.1.</span> <span class="toc-text">5.6.1.查看执行频次</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.6.2.</span> <span class="toc-text">5.6.2.慢查询日志⭐⭐⭐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-3-profile%E6%93%8D%E4%BD%9C"><span class="toc-number">5.6.3.</span> <span class="toc-text">5.6.3.profile操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-4-explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">5.6.4.</span> <span class="toc-text">5.6.4.explain执行计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99"><span class="toc-number">5.7.</span> <span class="toc-text">5.7.索引使用规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-1-%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.7.1.</span> <span class="toc-text">5.7.1.最左前缀法则⭐⭐⭐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-2-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.7.2.</span> <span class="toc-text">5.7.2.索引失效情况⭐⭐⭐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-3-SQL-%E6%8F%90%E7%A4%BA"><span class="toc-number">5.7.3.</span> <span class="toc-text">5.7.3.SQL 提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-4-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95-amp-%E5%9B%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.7.4.</span> <span class="toc-text">5.7.4.覆盖索引&amp;回表查询⭐⭐⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">5.7.4.0.1.</span> <span class="toc-text">面试题⭐⭐⭐</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-5-%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="toc-number">5.7.5.</span> <span class="toc-text">5.7.5.前缀索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-6-%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">5.7.6.</span> <span class="toc-text">5.7.6.设计原则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-SQL%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">6.SQL优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">6.1.</span> <span class="toc-text">6.1.插入数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%B8%BB%E9%94%AE%E4%BC%98%E5%8C%96"><span class="toc-number">6.2.</span> <span class="toc-text">6.2.主键优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-order-by-%E4%BC%98%E5%8C%96"><span class="toc-number">6.3.</span> <span class="toc-text">6.3. order by 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-group-by-%E4%BC%98%E5%8C%96"><span class="toc-number">6.4.</span> <span class="toc-text">6.4. group by 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-limit-%E4%BC%98%E5%8C%96"><span class="toc-number">6.5.</span> <span class="toc-text">6.5. limit 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-count-%E4%BC%98%E5%8C%96"><span class="toc-number">6.6.</span> <span class="toc-text">6.6. count 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-update-%E4%BC%98%E5%8C%96%EF%BC%88%E9%81%BF%E5%85%8D%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81%EF%BC%89"><span class="toc-number">6.7.</span> <span class="toc-text">6.7. update 优化（避免行锁升级为表锁）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E9%94%81"><span class="toc-number">7.</span> <span class="toc-text">7.锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%85%A8%E5%B1%80%E9%94%81"><span class="toc-number">7.1.</span> <span class="toc-text">7.1.全局锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="toc-number">7.2.</span> <span class="toc-text">7.2.表级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">7.2.1.</span> <span class="toc-text">7.2.1.读写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2-%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81-meta-data-lock%EF%BC%8C-MDL"><span class="toc-number">7.2.2.</span> <span class="toc-text">7.2.2.元数据锁 (meta data lock， MDL)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-3-%E6%84%8F%E5%90%91%E9%94%81"><span class="toc-number">7.2.3.</span> <span class="toc-text">7.2.3.意向锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-number">7.3.</span> <span class="toc-text">7.3.行级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-1-%E8%A1%8C%E9%94%81"><span class="toc-number">7.3.1.</span> <span class="toc-text">7.3.1.行锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-2-%E9%97%B4%E9%9A%99%E9%94%81-%E4%B8%B4%E9%94%AE%E9%94%81%EF%BC%88%E5%AD%A6%E7%9A%84%E4%B8%8D%E6%98%AF%E5%BE%88%E6%87%82%E2%AD%90%E2%AD%90%E2%AD%90%EF%BC%89"><span class="toc-number">7.3.2.</span> <span class="toc-text">7.3.2.间隙锁&#x2F;临键锁（学的不是很懂⭐⭐⭐）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-InnoDB%E5%BC%95%E6%93%8E"><span class="toc-number">8.</span> <span class="toc-text">8.InnoDB引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-InnoDB%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">8.1.</span> <span class="toc-text">8.1.InnoDB逻辑存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E6%9E%B6%E6%9E%84"><span class="toc-number">8.2.</span> <span class="toc-text">8.2.架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-%E5%86%85%E5%AD%98%E6%9E%B6%E6%9E%84"><span class="toc-number">8.2.1.</span> <span class="toc-text">8.2.1.内存架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84"><span class="toc-number">8.2.2.</span> <span class="toc-text">8.2.2.磁盘结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-3-%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B"><span class="toc-number">8.2.3.</span> <span class="toc-text">8.2.3.后台线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">8.3.</span> <span class="toc-text">8.3.事务原理⭐⭐⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-redo-log"><span class="toc-number">8.3.1.</span> <span class="toc-text">8.3.1.redo log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2-undo-log"><span class="toc-number">8.3.2.</span> <span class="toc-text">8.3.2.undo log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-3-MVCC%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">8.3.3.</span> <span class="toc-text">8.3.3.MVCC⭐⭐⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-3-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">8.3.3.1.基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="toc-number">8.3.3.1.1.</span> <span class="toc-text">当前读</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="toc-number">8.3.3.1.2.</span> <span class="toc-text">快照读</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MVCC"><span class="toc-number">8.3.3.1.3.</span> <span class="toc-text">MVCC</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5"><span class="toc-number">8.3.3.1.4.</span> <span class="toc-text">记录中的隐藏字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undo-log"><span class="toc-number">8.3.3.1.5.</span> <span class="toc-text">undo log</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undo-log%E7%89%88%E6%9C%AC%E9%93%BE"><span class="toc-number">8.3.3.1.6.</span> <span class="toc-text">undo log版本链</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#readview"><span class="toc-number">8.3.3.1.7.</span> <span class="toc-text">readview</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-4-%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">8.3.4.</span> <span class="toc-text">8.3.4.事务原理总结⭐⭐⭐</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-MySQL%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">9.MySQL管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">9.1.</span> <span class="toc-text">9.1.系统数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">9.2.</span> <span class="toc-text">9.2.常用工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-1-mysql"><span class="toc-number">9.2.1.</span> <span class="toc-text">9.2.1.mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-2-mysqladmin"><span class="toc-number">9.2.2.</span> <span class="toc-text">9.2.2.mysqladmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-3-mysqlbinlog%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">9.2.3.</span> <span class="toc-text">9.2.3.mysqlbinlog⭐⭐⭐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-4-mysqlshow"><span class="toc-number">9.2.4.</span> <span class="toc-text">9.2.4.mysqlshow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-5-mysqldump"><span class="toc-number">9.2.5.</span> <span class="toc-text">9.2.5.mysqldump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-6-mysqlimport"><span class="toc-number">9.2.6.</span> <span class="toc-text">9.2.6.mysqlimport</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-7-source"><span class="toc-number">9.2.7.</span> <span class="toc-text">9.2.7.source</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E8%BF%90%E7%BB%B4"><span class="toc-number">10.</span> <span class="toc-text">10.运维</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E6%97%A5%E5%BF%97%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">10.1.</span> <span class="toc-text">10.1.日志⭐⭐⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-1-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">10.1.1.</span> <span class="toc-text">10.1.1.错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-2-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-number">10.1.2.</span> <span class="toc-text">10.1.2.二进制日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">日志格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">日志查看</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4"><span class="toc-number">10.1.2.3.</span> <span class="toc-text">日志删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-3-%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">10.1.3.</span> <span class="toc-text">10.1.3.查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-4-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">10.1.4.</span> <span class="toc-text">10.1.4.慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">10.2.</span> <span class="toc-text">10.2.主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">10.2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">10.2.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E2%AD%90%E2%AD%90%E2%AD%90"><span class="toc-number">10.2.3.</span> <span class="toc-text">原理⭐⭐⭐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA"><span class="toc-number">10.2.4.</span> <span class="toc-text">搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">10.2.4.0.1.</span> <span class="toc-text">主库配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">10.2.4.0.2.</span> <span class="toc-text">从库配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">10.2.4.0.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">10.3.</span> <span class="toc-text">10.3.分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-1-%E6%8B%86%E5%88%86%E6%96%B9%E5%BC%8F"><span class="toc-number">10.3.1.</span> <span class="toc-text">10.3.1.拆分方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-2-MyCat%E6%9E%B6%E6%9E%84"><span class="toc-number">10.3.2.</span> <span class="toc-text">10.3.2.MyCat架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-3-%E5%85%A5%E9%97%A8"><span class="toc-number">10.3.3.</span> <span class="toc-text">10.3.3.入门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">10.3.3.0.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">10.3.3.0.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">10.3.3.0.3.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEschema-xml"><span class="toc-number">10.3.3.0.4.</span> <span class="toc-text">配置schema.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEserver-xml"><span class="toc-number">10.3.3.0.5.</span> <span class="toc-text">配置server.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.3.3.0.6.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95mycat"><span class="toc-number">10.3.3.0.7.</span> <span class="toc-text">登录mycat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-4-MyCat%E9%85%8D%E7%BD%AE"><span class="toc-number">10.3.4.</span> <span class="toc-text">10.3.4.MyCat配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#schema-xml"><span class="toc-number">10.3.4.1.</span> <span class="toc-text">schema.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rule-xml"><span class="toc-number">10.3.4.2.</span> <span class="toc-text">rule.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server-xml"><span class="toc-number">10.3.4.3.</span> <span class="toc-text">server.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-5-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93%E7%A4%BA%E4%BE%8B"><span class="toc-number">10.3.5.</span> <span class="toc-text">10.3.5.垂直分库示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">10.4.</span> <span class="toc-text">10.4.读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-1-%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">10.4.1.</span> <span class="toc-text">10.4.1.一主一从读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-2-%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">10.4.2.</span> <span class="toc-text">10.4.2.双主双从读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.4.2.0.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-1"><span class="toc-number">10.4.2.0.2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA-1"><span class="toc-number">10.4.2.0.3.</span> <span class="toc-text">搭建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">10.4.2.0.4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E2%80%94%E2%80%94MyCat"><span class="toc-number">10.4.2.0.5.</span> <span class="toc-text">搭建读写分离——MyCat</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8mycat"><span class="toc-number">10.4.2.0.6.</span> <span class="toc-text">启动mycat</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95mycat-1"><span class="toc-number">10.4.2.0.7.</span> <span class="toc-text">登录mycat</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">10.4.2.0.8.</span> <span class="toc-text">测试主从复制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">10.4.2.0.9.</span> <span class="toc-text">测试高可用</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/9.html" title="【算法】力扣347（前K个高频元素）"><img src="http://cdn.leesin.fun/hexo/article/9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【算法】力扣347（前K个高频元素）"/></a><div class="content"><a class="title" href="/post/9.html" title="【算法】力扣347（前K个高频元素）">【算法】力扣347（前K个高频元素）</a><time datetime="2023-04-10T09:42:58.006Z" title="发表于 2023-04-10 17:42:58">2023-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/8.html" title="【算法】力扣239（滑动窗口最大值）"><img src="http://cdn.leesin.fun/hexo/article/8.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【算法】力扣239（滑动窗口最大值）"/></a><div class="content"><a class="title" href="/post/8.html" title="【算法】力扣239（滑动窗口最大值）">【算法】力扣239（滑动窗口最大值）</a><time datetime="2023-04-10T03:33:55.191Z" title="发表于 2023-04-10 11:33:55">2023-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/17.html" title="【算法】力扣142（环形链表II）"><img src="http://cdn.leesin.fun/hexo/article/7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【算法】力扣142（环形链表II）"/></a><div class="content"><a class="title" href="/post/17.html" title="【算法】力扣142（环形链表II）">【算法】力扣142（环形链表II）</a><time datetime="2023-04-06T12:51:45.558Z" title="发表于 2023-04-06 20:51:45">2023-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/15.html" title="redis哨兵集群"><img src="http://cdn.leesin.fun/hexo/article/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="redis哨兵集群"/></a><div class="content"><a class="title" href="/post/15.html" title="redis哨兵集群">redis哨兵集群</a><time datetime="2023-03-30T13:05:50.000Z" title="发表于 2023-03-30 21:05:50">2023-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/14.html" title="redis主从复制"><img src="http://cdn.leesin.fun/hexo/article/4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="redis主从复制"/></a><div class="content"><a class="title" href="/post/14.html" title="redis主从复制">redis主从复制</a><time datetime="2023-03-30T11:53:50.000Z" title="发表于 2023-03-30 19:53:50">2023-03-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By leesin</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/jquery.js"></script><script src="/js/foot.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script src="/js/sun_moon.js" async></script><div class="aplayer no-destroy" data-id="8261498022" data-server="netease" data-type="playlist"  data-mini="true" data-fixed="true" data-autoplay="false" data-listfolded="true" data-lrctype="0"> </div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>